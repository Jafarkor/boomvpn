<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VPN Admin</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg:#0d0f18; --s1:#141824; --s2:#1c2133; --b:#252b42;
  --acc:#7c6ef5; --grn:#34d399; --ylw:#fbbf24; --red:#f87171;
  --txt:#e2e8f0; --dim:#64748b; --r:10px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--txt);font:14px/1.5 'Inter','Segoe UI',system-ui,sans-serif;height:100vh;overflow:hidden}

/* â”€â”€ Layout â”€â”€ */
#login{display:flex;align-items:center;justify-content:center;height:100vh;
  background:radial-gradient(ellipse 80% 60% at 50% -10%,#1e1b4b,var(--bg))}
#app{display:none;height:100vh;display:none}
.shell{display:flex;height:100vh}

/* â”€â”€ Sidebar â”€â”€ */
.side{width:220px;flex-shrink:0;background:var(--s1);border-right:1px solid var(--b);
  display:flex;flex-direction:column;overflow:hidden}
.brand{padding:20px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--b)}
.brand-icon{font-size:24px}
.brand-name{font-size:15px;font-weight:700}
.brand-sub{font-size:10px;color:var(--dim);letter-spacing:.05em}
nav{flex:1;padding:10px 8px;overflow-y:auto}
.nav-sec{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;padding:12px 8px 4px}
.ni{display:flex;align-items:center;gap:8px;padding:9px 10px;border-radius:7px;
  cursor:pointer;color:var(--dim);font-size:13px;font-weight:500;transition:.15s;margin-bottom:1px}
.ni:hover{background:var(--s2);color:var(--txt)}
.ni.on{background:rgba(124,110,245,.14);color:var(--acc)}
.ni .ic{width:18px;text-align:center;font-size:14px}
.side-foot{padding:12px;border-top:1px solid var(--b)}
.out-btn{width:100%;padding:9px;background:0;border:1px solid var(--b);border-radius:7px;
  color:var(--dim);cursor:pointer;font-size:12px;transition:.15s}
.out-btn:hover{border-color:var(--red);color:var(--red)}

/* â”€â”€ Main â”€â”€ */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.topbar{padding:16px 24px;background:var(--s1);border-bottom:1px solid var(--b);
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.topbar h1{font-size:17px;font-weight:700}
.online{background:rgba(52,211,153,.12);color:var(--grn);border-radius:20px;
  padding:3px 10px;font-size:11px;font-weight:600}
.view{flex:1;overflow-y:auto;padding:20px 24px}

/* â”€â”€ Login card â”€â”€ */
.lcard{background:var(--s1);border:1px solid var(--b);border-radius:18px;
  padding:40px 36px;width:360px;text-align:center;box-shadow:0 32px 64px rgba(0,0,0,.5)}
.lcard h1{font-size:22px;font-weight:700;margin:12px 0 6px}
.lcard p{color:var(--dim);font-size:13px;margin-bottom:28px}
.linput{width:100%;padding:12px 14px;background:var(--s2);border:1px solid var(--b);
  border-radius:8px;color:var(--txt);font-size:14px;outline:none;margin-bottom:12px;transition:.2s}
.linput:focus{border-color:var(--acc)}
.lbtn{width:100%;padding:13px;background:var(--acc);color:#fff;border:none;border-radius:8px;
  font-size:14px;font-weight:600;cursor:pointer;transition:.2s}
.lbtn:hover{opacity:.85}
.lerr{color:var(--red);font-size:12px;margin-top:10px}

/* â”€â”€ Stats grid â”€â”€ */
.sg{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;margin-bottom:20px}
.sc{background:var(--s1);border:1px solid var(--b);border-radius:var(--r);padding:18px;position:relative;overflow:hidden}
.sc::after{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.sc.p::after{background:var(--acc)} .sc.g::after{background:var(--grn)}
.sc.y::after{background:var(--ylw)} .sc.r::after{background:var(--red)}
.sl{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
.sv{font-size:26px;font-weight:700;margin-bottom:2px}
.ss{font-size:11px;color:var(--dim)}

/* â”€â”€ Charts â”€â”€ */
.cg{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px}
.cc{background:var(--s1);border:1px solid var(--b);border-radius:var(--r);padding:18px}
.ct{font-size:12px;font-weight:600;color:var(--dim);margin-bottom:14px}

/* â”€â”€ Table card â”€â”€ */
.tc{background:var(--s1);border:1px solid var(--b);border-radius:var(--r);overflow:hidden}
.th{padding:14px 18px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;
  border-bottom:1px solid var(--b);justify-content:space-between}
.th h2{font-size:14px;font-weight:600}
.th-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.si{background:var(--s2);border:1px solid var(--b);border-radius:7px;padding:7px 11px;
  color:var(--txt);font-size:12px;outline:none;min-width:170px;transition:.2s}
.si:focus{border-color:var(--acc)}
.fsel{background:var(--s2);border:1px solid var(--b);border-radius:7px;
  padding:7px 10px;color:var(--txt);font-size:12px;outline:none;cursor:pointer}
table{width:100%;border-collapse:collapse}
thead th{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.05em;
  padding:10px 14px;text-align:left;border-bottom:1px solid var(--b);white-space:nowrap}
td{padding:10px 14px;font-size:12px;border-bottom:1px solid rgba(37,43,66,.6);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,255,255,.015)}
.empty-row td{text-align:center;color:var(--dim);padding:32px}

/* â”€â”€ Badges â”€â”€ */
.bd{display:inline-flex;align-items:center;border-radius:20px;padding:2px 9px;font-size:10px;font-weight:600}
.bd.g{background:rgba(52,211,153,.13);color:var(--grn)}
.bd.r{background:rgba(248,113,113,.13);color:var(--red)}
.bd.y{background:rgba(251,191,36,.13);color:var(--ylw)}
.bd.p{background:rgba(124,110,245,.13);color:var(--acc)}
.bd.d{background:rgba(100,116,139,.13);color:var(--dim)}

/* â”€â”€ Buttons â”€â”€ */
.btn{padding:5px 10px;border-radius:6px;border:none;cursor:pointer;font-size:11px;
  font-weight:600;transition:.15s;display:inline-flex;align-items:center;gap:4px;white-space:nowrap}
.btn:disabled{opacity:.45;cursor:not-allowed}
.btn-acc{background:rgba(124,110,245,.2);color:var(--acc);border:1px solid rgba(124,110,245,.3)}
.btn-acc:hover:not(:disabled){background:rgba(124,110,245,.35)}
.btn-grn{background:rgba(52,211,153,.15);color:var(--grn);border:1px solid rgba(52,211,153,.3)}
.btn-grn:hover:not(:disabled){background:rgba(52,211,153,.28)}
.btn-red{background:rgba(248,113,113,.13);color:var(--red);border:1px solid rgba(248,113,113,.3)}
.btn-red:hover:not(:disabled){background:rgba(248,113,113,.25)}
.btn-d{background:0;color:var(--dim);border:1px solid var(--b)}
.btn-d:hover{color:var(--txt);border-color:var(--txt)}
.btn-lg{padding:11px 20px;font-size:13px;border-radius:8px}
.btn-full{width:100%;justify-content:center}

/* â”€â”€ Action group in table â”€â”€ */
.acts{display:flex;gap:4px;flex-wrap:nowrap}

/* â”€â”€ Pagination â”€â”€ */
.pg{display:flex;align-items:center;justify-content:center;gap:6px;padding:14px}
.pb{padding:5px 11px;background:var(--s2);border:1px solid var(--b);border-radius:6px;
  color:var(--txt);cursor:pointer;font-size:12px;transition:.15s}
.pb:hover{border-color:var(--acc);color:var(--acc)}
.pb.on{background:var(--acc);border-color:var(--acc);color:#fff}
.pb:disabled{opacity:.35;cursor:not-allowed}
.ptxt{font-size:12px;color:var(--dim)}

/* â”€â”€ Modal â”€â”€ */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;
  display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.mo{background:var(--s1);border:1px solid var(--b);border-radius:14px;padding:24px;
  width:90%;max-width:560px;max-height:85vh;overflow-y:auto;box-shadow:0 32px 64px rgba(0,0,0,.6)}
.mo-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px}
.mo-title{font-size:16px;font-weight:700}
.mo-sub{font-size:12px;color:var(--dim);margin-top:2px}
.mo-x{background:none;border:none;color:var(--dim);cursor:pointer;font-size:18px;padding:2px;line-height:1}
.mo-x:hover{color:var(--txt)}
.ir{display:flex;justify-content:space-between;align-items:center;padding:9px 0;
  border-bottom:1px solid rgba(37,43,66,.8);font-size:13px;gap:12px}
.ir:last-child{border-bottom:none}
.il{color:var(--dim);flex-shrink:0}
.iv{font-weight:500;max-width:300px;word-break:break-all;text-align:right}
.mo-act{display:flex;gap:8px;margin-top:20px;flex-wrap:wrap}
.mo-sect{font-size:12px;font-weight:600;color:var(--dim);margin:16px 0 8px;
  text-transform:uppercase;letter-spacing:.05em}

/* â”€â”€ Sub history mini-table â”€â”€ */
.mini-t{width:100%;border-collapse:collapse;border:1px solid var(--b);border-radius:8px;overflow:hidden}
.mini-t th{font-size:10px;color:var(--dim);text-transform:uppercase;padding:8px 10px;
  background:var(--s2);text-align:left;letter-spacing:.04em}
.mini-t td{padding:8px 10px;font-size:11px;border-top:1px solid var(--b)}

/* â”€â”€ Confirm modal â”€â”€ */
.confirm-icon{font-size:40px;text-align:center;margin-bottom:12px}
.confirm-msg{text-align:center;color:var(--dim);font-size:13px;margin-bottom:20px;line-height:1.6}

/* â”€â”€ SQL editor â”€â”€ */
.sqle{width:100%;min-height:110px;background:var(--s2);border:1px solid var(--b);border-radius:8px;
  padding:12px;color:var(--txt);font-family:'Courier New',monospace;font-size:12px;
  outline:none;resize:vertical;transition:.2s;margin-bottom:10px}
.sqle:focus{border-color:var(--acc)}
.sql-chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.chip{padding:4px 10px;background:var(--s2);border:1px solid var(--b);border-radius:20px;
  font-size:11px;color:var(--dim);cursor:pointer;transition:.15s}
.chip:hover{border-color:var(--acc);color:var(--acc)}
.sql-res{margin-top:14px;overflow-x:auto;border:1px solid var(--b);border-radius:8px}
.sql-err{margin-top:12px;padding:10px 14px;background:rgba(248,113,113,.08);
  border:1px solid rgba(248,113,113,.25);border-radius:8px;color:var(--red);font-family:monospace;font-size:12px}

/* â”€â”€ Broadcast â”€â”€ */
.bcast-ta{width:100%;min-height:140px;background:var(--s2);border:1px solid var(--b);
  border-radius:8px;padding:12px;color:var(--txt);font-size:13px;outline:none;resize:vertical;
  transition:.2s;margin-bottom:10px}
.bcast-ta:focus{border-color:var(--acc)}
.chk-row{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--dim);
  margin-bottom:14px;cursor:pointer;user-select:none}
.chk-row input{accent-color:var(--acc);width:15px;height:15px;cursor:pointer}
.bcast-ok{margin-top:14px;padding:10px 14px;background:rgba(52,211,153,.08);
  border:1px solid rgba(52,211,153,.25);border-radius:8px;color:var(--grn);font-size:13px}

/* â”€â”€ Loading / spinner â”€â”€ */
.ld{display:flex;align-items:center;justify-content:center;padding:48px;color:var(--dim);gap:10px}
.sp{width:18px;height:18px;border:2px solid var(--b);border-top-color:var(--acc);
  border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ Toast â”€â”€ */
#toast{position:fixed;bottom:20px;right:20px;background:var(--s2);border:1px solid var(--b);
  border-radius:9px;padding:12px 18px;font-size:13px;z-index:999;
  transform:translateY(80px);opacity:0;transition:.28s;pointer-events:none}
#toast.show{transform:translateY(0);opacity:1}
#toast.ok{border-color:rgba(52,211,153,.5);color:var(--grn)}
#toast.err{border-color:rgba(248,113,113,.5);color:var(--red)}

/* â”€â”€ Sub status in table â”€â”€ */
.sub-col{display:flex;flex-direction:column;gap:2px}
.sub-days{font-size:10px;color:var(--dim)}

@media(max-width:700px){.side{display:none}.cg{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- Login -->
<div id="login">
  <div class="lcard">
    <div style="font-size:44px">ğŸ›¡ï¸</div>
    <h1>VPN Admin</h1>
    <p>Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°</p>
    <input class="linput" type="password" id="pw" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ"
      onkeydown="if(event.key==='Enter')login()">
    <button class="lbtn" onclick="login()">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</button>
    <div class="lerr" id="lerr"></div>
  </div>
</div>

<!-- App -->
<div id="app">
<div class="shell">
  <aside class="side">
    <div class="brand">
      <div class="brand-icon">ğŸ›¡ï¸</div>
      <div><div class="brand-name">VPN Admin</div><div class="brand-sub">PANEL v2</div></div>
    </div>
    <nav>
      <div class="nav-sec">Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ</div>
      <div class="ni on" data-p="dash" onclick="go('dash')"><span class="ic">ğŸ“Š</span>Ğ”Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´</div>
      <div class="nav-sec">Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…</div>
      <div class="ni" data-p="users" onclick="go('users')"><span class="ic">ğŸ‘¥</span>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸</div>
      <div class="ni" data-p="payments" onclick="go('payments')"><span class="ic">ğŸ’°</span>ĞŸĞ»Ğ°Ñ‚ĞµĞ¶Ğ¸</div>
      <div class="nav-sec">Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹</div>
      <div class="ni" data-p="broadcast" onclick="go('broadcast')"><span class="ic">ğŸ“¢</span>Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ°</div>
      <div class="ni" data-p="sql" onclick="go('sql')"><span class="ic">ğŸ”</span>SQL-ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ</div>
    </nav>
    <div class="side-foot"><button class="out-btn" onclick="logout()">ğŸšª Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button></div>
  </aside>

  <div class="main">
    <div class="topbar">
      <h1 id="ptitle">Ğ”Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´</h1>
      <span class="online">â— ĞĞ½Ğ»Ğ°Ğ¹Ğ½</span>
    </div>
    <div class="view" id="view"><div class="ld"><div class="sp"></div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div></div>
  </div>
</div>
</div>

<!-- Modal -->
<div class="ov" id="modal" style="display:none" onclick="if(event.target===this)closeMo()">
  <div class="mo" id="mo-body"></div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const $ = id => document.getElementById(id);
let _charts = {};

// â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(path, opts = {}) {
  const r = await fetch('/api' + path, {
    headers: {'Content-Type': 'application/json'},
    ...opts,
    body: opts.body !== undefined ? JSON.stringify(opts.body) : undefined,
  });
  return r.json();
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type = 'ok') {
  const el = $('toast');
  el.textContent = msg;
  el.className = `show ${type}`;
  clearTimeout(window._tt);
  window._tt = setTimeout(() => el.className = '', 3000);
}

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openMo(html) { $('mo-body').innerHTML = html; $('modal').style.display = 'flex'; }
function closeMo()    { $('modal').style.display = 'none'; }

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkAuth() {
  const d = await api('/me');
  if (d.logged_in) showApp(); else { $('login').style.display = 'flex'; }
}

async function login() {
  const d = await api('/login', {method:'POST', body:{password: $('pw').value}});
  if (d.ok) showApp(); else $('lerr').textContent = d.error || 'ĞÑˆĞ¸Ğ±ĞºĞ°';
}

async function logout() {
  await api('/logout', {method:'POST'});
  $('app').style.display = 'none';
  $('login').style.display = 'flex';
  $('pw').value = '';
}

function showApp() {
  $('login').style.display = 'none';
  $('app').style.display = 'block';
  go('dash');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PAGE_TITLES = {dash:'Ğ”Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´', users:'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸', payments:'ĞŸĞ»Ğ°Ñ‚ĞµĞ¶Ğ¸', broadcast:'Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ°', sql:'SQL-ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ'};
const PAGE_FNS    = {dash:renderDash, users:renderUsers, payments:renderPayments, broadcast:renderBroadcast, sql:renderSQL};

function go(page) {
  document.querySelectorAll('.ni').forEach(el => el.classList.toggle('on', el.dataset.p === page));
  $('ptitle').textContent = PAGE_TITLES[page] || page;
  (PAGE_FNS[page] || (() => {}))();
}

function setView(html) { $('view').innerHTML = html; }
function loading()     { setView('<div class="ld"><div class="sp"></div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function renderDash() {
  loading();
  const d = await api('/stats');
  setView(`
    <div class="sg">
      <div class="sc p"><div class="sl">ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸</div><div class="sv">${d.total_users}</div><div class="ss">+${d.new_today} Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ</div></div>
      <div class="sc g"><div class="sl">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº</div><div class="sv">${d.active_subs}</div><div class="ss">${d.expiring} Ğ¸ÑÑ‚ĞµĞºĞ°ÑÑ‚ ÑĞºĞ¾Ñ€Ğ¾</div></div>
      <div class="sc y"><div class="sl">Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ° Ğ·Ğ° Ğ¼ĞµÑÑÑ†</div><div class="sv">${fmtM(d.revenue_month)}</div><div class="ss">Ğ’ÑĞµĞ³Ğ¾: ${fmtM(d.revenue_total)}</div></div>
      <div class="sc r"><div class="sl">Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾</div><div class="sv">${d.banned}</div><div class="ss">â€”</div></div>
    </div>
    <div class="cg">
      <div class="cc"><div class="ct">ğŸ’° Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ°, 14 Ğ´Ğ½ĞµĞ¹</div><canvas id="cr" height="130"></canvas></div>
      <div class="cc"><div class="ct">ğŸ‘¤ Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸, 14 Ğ´Ğ½ĞµĞ¹</div><canvas id="crg" height="130"></canvas></div>
    </div>`);
  chart('cr',  d.revenue_chart, 'Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ°', '#7c6ef5');
  chart('crg', d.reg_chart,     'Ğ ĞµĞ³.',    '#34d399');
}

function chart(id, data, label, color) {
  if (_charts[id]) _charts[id].destroy();
  _charts[id] = new Chart($(id), {
    type: 'line',
    data: {
      labels: data.map(r => r.day?.slice(5) || ''),
      datasets: [{label, data: data.map(r => r.total), borderColor: color,
        backgroundColor: color+'1a', fill: true, tension: .4, pointRadius: 3}]
    },
    options: {responsive:true, plugins:{legend:{display:false}},
      scales:{x:{grid:{color:'#252b4222'}, ticks:{color:'#64748b',font:{size:10}}},
              y:{grid:{color:'#252b4222'}, ticks:{color:'#64748b',font:{size:10}}}}}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USERS â€” list + subscription management
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let uState = {page:1, search:'', status:'', total:0};

async function renderUsers() {
  loading();
  const p = new URLSearchParams({page:uState.page, per_page:25, search:uState.search, status:uState.status});
  const d = await api('/users?' + p);
  uState.total = d.total;

  const rows = d.users.map(userRow).join('');
  const totalPages = Math.ceil(d.total / d.per_page);

  setView(`
    <div class="tc">
      <div class="th">
        <h2>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ <span style="color:var(--dim);font-weight:400">(${d.total})</span></h2>
        <div class="th-tools">
          <input class="si" placeholder="ğŸ” ĞŸĞ¾Ğ¸ÑĞº..." value="${esc(uState.search)}"
            oninput="uState.search=this.value;uState.page=1;renderUsers()" style="width:160px">
          <select class="fsel" onchange="uState.status=this.value;uState.page=1;renderUsers()">
            <option value="">Ğ’ÑĞµ</option>
            <option value="active_sub"  ${uState.status==='active_sub' ?'selected':''}>Ğ¡ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¾Ğ¹</option>
            <option value="no_sub"      ${uState.status==='no_sub'     ?'selected':''}>Ğ‘ĞµĞ· Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸</option>
            <option value="banned"      ${uState.status==='banned'     ?'selected':''}>Ğ—Ğ°Ğ±Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ğµ</option>
          </select>
          <button class="btn btn-d" onclick="renderUsers()">â†»</button>
        </div>
      </div>
      <table>
        <thead><tr>
          <th>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</th><th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th><th>ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°</th><th>ĞŸĞ¾Ñ‚Ñ€Ğ°Ñ‡ĞµĞ½Ğ¾</th><th>Ğ”Ğ°Ñ‚Ğ° Ñ€ĞµĞ³.</th><th>Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</th>
        </tr></thead>
        <tbody>${rows || '<tr class="empty-row"><td colspan="6">ĞĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</td></tr>'}</tbody>
      </table>
      ${pagination(uState.page, totalPages, 'uState.page', 'renderUsers')}
    </div>`);
}

function userRow(u) {
  const subBadge = subStatusBadge(u);
  const actions  = subActions(u);
  return `<tr>
    <td>
      <div style="font-weight:600">${esc(u.first_name || 'â€”')}</div>
      <div style="color:var(--dim);font-size:11px">${u.username ? '@'+esc(u.username) : ''} <code style="font-size:10px">${u.user_id}</code></div>
    </td>
    <td><span class="bd ${u.is_banned?'r':'g'}">${u.is_banned?'ğŸš« Ğ‘Ğ°Ğ½':'âœ“ OK'}</span></td>
    <td>${subBadge}</td>
    <td>${fmtM(u.total_spent)}</td>
    <td style="white-space:nowrap">${fmtD(u.registered_at)}</td>
    <td><div class="acts">${actions}<button class="btn btn-d" onclick="showUser(${u.user_id})">â€¦</button></div></td>
  </tr>`;
}

function subStatusBadge(u) {
  if (!u.sub_id) return '<span class="bd d">ĞĞµÑ‚</span>';
  const exp = new Date(u.expires_at);
  const now = new Date();
  if (!u.sub_active || exp <= now) return '<span class="bd r">Ğ˜ÑÑ‚ĞµĞºĞ»Ğ°</span>';
  const days = Math.ceil((exp - now) / 86400000);
  const cls  = days <= 3 ? 'y' : 'g';
  return `<div class="sub-col"><span class="bd ${cls}">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°</span><span class="sub-days">${days}Ğ´. Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ</span></div>`;
}

function subActions(u) {
  const hasActive = u.sub_id && u.sub_active && new Date(u.expires_at) > new Date();
  const hasAny    = !!u.sub_id;

  if (!hasAny) {
    return `<button class="btn btn-grn" onclick="confirmGrant(${u.user_id}, '${esc(u.first_name)}')">ğŸ Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ</button>`;
  }
  if (hasActive) {
    return `
      <button class="btn btn-acc" onclick="confirmExtend(${u.user_id}, '${esc(u.first_name)}')">â• ĞŸÑ€Ğ¾Ğ´Ğ»Ğ¸Ñ‚ÑŒ</button>
      <button class="btn btn-red" onclick="confirmDisable(${u.user_id}, '${esc(u.first_name)}')">â¹ ĞÑ‚ĞºĞ».</button>`;
  }
  // has sub but expired
  return `<button class="btn btn-grn" onclick="confirmGrant(${u.user_id}, '${esc(u.first_name)}')">ğŸ”„ ĞŸÑ€Ğ¾Ğ´Ğ»Ğ¸Ñ‚ÑŒ</button>`;
}

// â”€â”€ User detail modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showUser(uid) {
  openMo('<div class="ld"><div class="sp"></div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>');
  const d = await api('/users/' + uid);
  if (d.error) { closeMo(); toast(d.error, 'err'); return; }
  const u = d.user;
  const hasActive = u.sub_id && u.sub_active && new Date(u.expires_at) > new Date();

  const subRows = d.subscriptions.slice(0, 5).map(s => {
    const ok = s.is_active && new Date(s.expires_at) > new Date();
    return `<tr>
      <td>#${s.id}</td>
      <td><code>${s.marzban_username}</code></td>
      <td><span class="bd ${ok?'g':'r'}">${ok?'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°':'Ğ˜ÑÑ‚ĞµĞºĞ»Ğ°'}</span></td>
      <td>${fmtD(s.expires_at)}</td>
    </tr>`;
  }).join('') || '<tr><td colspan="4" style="text-align:center;color:var(--dim);padding:10px">ĞĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº</td></tr>';

  const payRows = d.payments.slice(0, 5).map(p =>
    `<tr><td><span class="bd ${p.status==='succeeded'?'g':p.status==='pending'?'y':'r'}">${p.status}</span></td>
     <td>${fmtM(p.amount)}</td><td>${fmtD(p.created_at)}</td></tr>`
  ).join('') || '<tr><td colspan="3" style="text-align:center;color:var(--dim);padding:10px">ĞĞµÑ‚ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹</td></tr>';

  openMo(`
    <div class="mo-head">
      <div>
        <div class="mo-title">${esc(u.first_name)} ${u.username?'@'+esc(u.username):''}</div>
        <div class="mo-sub">ID: ${u.user_id}</div>
      </div>
      <button class="mo-x" onclick="closeMo()">âœ•</button>
    </div>
    <div class="ir"><span class="il">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</span><span class="iv"><span class="bd ${u.is_banned?'r':'g'}">${u.is_banned?'Ğ—Ğ°Ğ±Ğ°Ğ½ĞµĞ½':'ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½'}</span></span></div>
    <div class="ir"><span class="il">ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°</span><span class="iv">${subStatusBadge(u)}</span></div>
    <div class="ir"><span class="il">Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</span><span class="iv">${fmtD(u.registered_at)}</span></div>
    <div class="ir"><span class="il">ĞŸĞ¾Ñ‚Ñ€Ğ°Ñ‡ĞµĞ½Ğ¾</span><span class="iv">${fmtM(u.total_spent)}</span></div>

    <div class="mo-sect">ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸</div>
    <table class="mini-t">
      <thead><tr><th>ID</th><th>Marzban</th><th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th><th>Ğ˜ÑÑ‚ĞµĞºĞ°ĞµÑ‚</th></tr></thead>
      <tbody>${subRows}</tbody>
    </table>

    <div class="mo-sect">ĞŸĞ»Ğ°Ñ‚ĞµĞ¶Ğ¸</div>
    <table class="mini-t">
      <thead><tr><th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th><th>Ğ¡ÑƒĞ¼Ğ¼Ğ°</th><th>Ğ”Ğ°Ñ‚Ğ°</th></tr></thead>
      <tbody>${payRows}</tbody>
    </table>

    <div class="mo-act">
      ${!hasActive ? `<button class="btn btn-grn" onclick="closeMo();confirmGrant(${u.user_id},'${esc(u.first_name)}')">ğŸ Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ</button>` : ''}
      ${hasActive  ? `<button class="btn btn-acc" onclick="closeMo();confirmExtend(${u.user_id},'${esc(u.first_name)}')">â• ĞŸÑ€Ğ¾Ğ´Ğ»Ğ¸Ñ‚ÑŒ</button>` : ''}
      ${hasActive  ? `<button class="btn btn-red" onclick="closeMo();confirmDisable(${u.user_id},'${esc(u.first_name)}')">â¹ ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ</button>` : ''}
      ${u.is_banned
        ? `<button class="btn btn-grn" onclick="doBan(${u.user_id},false)">âœ“ Ğ Ğ°Ğ·Ğ±Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>`
        : `<button class="btn btn-red" onclick="doBan(${u.user_id},true)">ğŸš« Ğ—Ğ°Ğ±Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>`}
    </div>`);
}

// â”€â”€ Subscription actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function confirmGrant(uid, name) {
  openMo(`
    <div class="confirm-icon">ğŸ</div>
    <div class="mo-title" style="text-align:center;margin-bottom:8px">Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ</div>
    <div class="confirm-msg">Ğ‘ÑƒĞ´ĞµÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ² Marzban Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ´Ğ»Ñ<br><b>${esc(name)}</b> (${uid})</div>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn btn-d btn-lg" onclick="closeMo()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn btn-grn btn-lg" id="cb" onclick="doGrant(${uid})">âœ“ Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ</button>
    </div>`);
}

function confirmExtend(uid, name) {
  openMo(`
    <div class="confirm-icon">â•</div>
    <div class="mo-title" style="text-align:center;margin-bottom:8px">ĞŸÑ€Ğ¾Ğ´Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ</div>
    <div class="confirm-msg">ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ´Ğ»Ñ <b>${esc(name)}</b> Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ° Ğ² Marzban Ğ¸ Ğ‘Ğ”</div>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn btn-d btn-lg" onclick="closeMo()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn btn-acc btn-lg" id="cb" onclick="doExtend(${uid})">âœ“ ĞŸÑ€Ğ¾Ğ´Ğ»Ğ¸Ñ‚ÑŒ</button>
    </div>`);
}

function confirmDisable(uid, name) {
  openMo(`
    <div class="confirm-icon">â¹</div>
    <div class="mo-title" style="text-align:center;margin-bottom:8px">ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ</div>
    <div class="confirm-msg">ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ <b>${esc(name)}</b> Ğ±ÑƒĞ´ĞµÑ‚ Ğ´ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°</div>
    <label class="chk-row" style="justify-content:center"><input type="checkbox" id="del-mz"> Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Marzban</label>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn btn-d btn-lg" onclick="closeMo()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn btn-red btn-lg" id="cb" onclick="doDisable(${uid})">âœ“ ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ</button>
    </div>`);
}

async function doGrant(uid) {
  setBtnLoading('cb', 'â³');
  const d = await api('/users/'+uid+'/sub/grant', {method:'POST', body:{}});
  closeMo();
  if (d.error) toast(d.error, 'err');
  else { toast('âœ… ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ²Ñ‹Ğ´Ğ°Ğ½Ğ°!'); renderUsers(); }
}

async function doExtend(uid) {
  setBtnLoading('cb', 'â³');
  const d = await api('/users/'+uid+'/sub/extend', {method:'POST', body:{}});
  closeMo();
  if (d.error) toast(d.error, 'err');
  else { toast('âœ… ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ°!'); renderUsers(); }
}

async function doDisable(uid) {
  const del = $('del-mz')?.checked || false;
  setBtnLoading('cb', 'â³');
  const d = await api('/users/'+uid+'/sub/disable', {method:'POST', body:{delete_marzban:del}});
  closeMo();
  if (d.error) toast(d.error, 'err');
  else { toast('ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ°'); renderUsers(); }
}

async function doBan(uid, banned) {
  const d = await api('/users/'+uid+'/ban', {method:'POST', body:{banned}});
  if (d.ok) { toast(banned ? 'ğŸš« Ğ—Ğ°Ğ±Ğ°Ğ½ĞµĞ½' : 'âœ“ Ğ Ğ°Ğ·Ğ±Ğ°Ğ½ĞµĞ½', banned?'err':'ok'); closeMo(); renderUsers(); }
}

function setBtnLoading(id, label) {
  const el = $(id);
  if (el) { el.textContent = label; el.disabled = true; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAYMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let pState = {page:1, status:''};

async function renderPayments() {
  loading();
  const p = new URLSearchParams({page:pState.page, per_page:25, status:pState.status});
  const d = await api('/payments?' + p);
  const totalPages = Math.ceil(d.total / d.per_page);

  const rows = d.payments.map(p => `<tr>
    <td><code style="font-size:10px">${p.user_id}</code><br>
      <span style="color:var(--dim);font-size:10px">${p.first_name||''} ${p.username?'@'+p.username:''}</span></td>
    <td><span class="bd ${p.status==='succeeded'?'g':p.status==='pending'?'y':'r'}">${p.status}</span></td>
    <td style="font-weight:600">${fmtM(p.amount)}</td>
    <td style="font-size:11px;color:var(--dim)">${p.yukassa_payment_id||'â€”'}</td>
    <td>${fmtD(p.created_at)}</td>
  </tr>`).join('');

  setView(`
    <div class="tc">
      <div class="th">
        <h2>ĞŸĞ»Ğ°Ñ‚ĞµĞ¶Ğ¸ <span style="color:var(--dim);font-weight:400">(${d.total})</span></h2>
        <div class="th-tools">
          <select class="fsel" onchange="pState.status=this.value;pState.page=1;renderPayments()">
            <option value="">Ğ’ÑĞµ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹</option>
            <option value="succeeded" ${pState.status==='succeeded'?'selected':''}>Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ</option>
            <option value="pending"   ${pState.status==='pending'  ?'selected':''}>ĞĞ¶Ğ¸Ğ´Ğ°ÑÑ‰Ğ¸Ğµ</option>
            <option value="canceled"  ${pState.status==='canceled' ?'selected':''}>ĞÑ‚Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ñ‹Ğµ</option>
          </select>
          <button class="btn btn-d" onclick="renderPayments()">â†»</button>
        </div>
      </div>
      <table>
        <thead><tr><th>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</th><th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th><th>Ğ¡ÑƒĞ¼Ğ¼Ğ°</th><th>Ğ®Kassa ID</th><th>Ğ”Ğ°Ñ‚Ğ°</th></tr></thead>
        <tbody>${rows || '<tr class="empty-row"><td colspan="5">ĞĞµÑ‚ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹</td></tr>'}</tbody>
      </table>
      ${pagination(pState.page, totalPages, 'pState.page', 'renderPayments')}
    </div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BROADCAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderBroadcast() {
  setView(`
    <div class="tc" style="padding:22px;max-width:620px">
      <h2 style="margin-bottom:6px">ğŸ“¢ Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ°</h2>
      <p style="color:var(--dim);font-size:13px;margin-bottom:18px">HTML-Ñ€Ğ°Ğ·Ğ¼ĞµÑ‚ĞºĞ° Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ: &lt;b&gt;, &lt;i&gt;, &lt;code&gt;, &lt;a&gt;</p>
      <textarea class="bcast-ta" id="bt" placeholder="Ğ¢ĞµĞºÑÑ‚ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸..."></textarea>
      <label class="chk-row">
        <input type="checkbox" id="oa"> Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¾Ğ¹
      </label>
      <button class="btn btn-acc btn-lg btn-full" id="sbtn" onclick="sendBroadcast()">ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
      <div id="bres" style="display:none"></div>
    </div>`);
}

async function sendBroadcast() {
  const text = $('bt').value.trim();
  if (!text) { toast('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‚ĞµĞºÑÑ‚', 'err'); return; }
  const btn = $('sbtn');
  btn.textContent = 'â³ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ°...'; btn.disabled = true;
  const d = await api('/broadcast', {method:'POST', body:{text, only_active: $('oa').checked}});
  btn.textContent = 'ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ'; btn.disabled = false;
  if (d.error) { toast(d.error, 'err'); return; }
  const el = $('bres');
  el.style.display = 'block';
  el.className = 'bcast-ok';
  el.innerHTML = `âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾: <b>${d.sent}</b>, Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº: <b>${d.failed}</b>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SQL CONSOLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SQL_CHIPS = [
  ['users', 'SELECT * FROM users ORDER BY registered_at DESC LIMIT 20'],
  ['active subs', "SELECT * FROM subscriptions WHERE is_active AND expires_at > NOW() LIMIT 20"],
  ['payments', "SELECT * FROM payments WHERE status='succeeded' ORDER BY created_at DESC LIMIT 20"],
  ['revenue/day', "SELECT DATE(created_at) day, COUNT(*) cnt, SUM(amount) rev FROM payments WHERE status='succeeded' GROUP BY day ORDER BY day DESC LIMIT 14"],
];

function renderSQL() {
  const chips = SQL_CHIPS.map(([l,q]) =>
    `<span class="chip" onclick="setSql(${JSON.stringify(q)})">${l}</span>`).join('');
  setView(`
    <div class="tc" style="padding:22px">
      <h2 style="margin-bottom:6px">ğŸ” SQL-ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ</h2>
      <p style="color:var(--dim);font-size:12px;margin-bottom:14px">Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ SELECT. Ctrl+Enter Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ.</p>
      <div class="sql-chips">${chips}</div>
      <textarea class="sqle" id="sqli" placeholder="SELECT ..."></textarea>
      <div style="display:flex;gap:8px">
        <button class="btn btn-acc" onclick="runSQL()">â–¶ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ</button>
        <button class="btn btn-d" onclick="$('sqli').value=''">ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ</button>
      </div>
      <div id="sqlo"></div>
    </div>`);
  $('sqli').addEventListener('keydown', e => { if (e.ctrlKey && e.key==='Enter') runSQL(); });
}

function setSql(q) { $('sqli').value = q; runSQL(); }

async function runSQL() {
  const sql = $('sqli')?.value?.trim();
  if (!sql) return;
  $('sqlo').innerHTML = '<div class="ld" style="padding:20px"><div class="sp"></div></div>';
  const d = await api('/query', {method:'POST', body:{sql}});
  if (d.error) { $('sqlo').innerHTML = `<div class="sql-err">âŒ ${esc(d.error)}</div>`; return; }
  if (!d.columns.length) { $('sqlo').innerHTML = '<div style="color:var(--dim);padding:14px;font-size:13px">ĞĞµÑ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²</div>'; return; }

  const ths = d.columns.map(c => `<th>${c}</th>`).join('');
  const trs = d.rows.map(r =>
    `<tr>${r.map(v => `<td style="font-size:11px">${v===null?'<span style="color:var(--dim)">null</span>':String(v).length>80?`<span title="${esc(String(v))}">${esc(String(v).slice(0,80))}â€¦</span>`:esc(String(v))}</td>`).join('')}</tr>`
  ).join('');
  $('sqlo').innerHTML = `
    <div style="font-size:11px;color:var(--dim);padding:10px 0 6px">Ğ¡Ñ‚Ñ€Ğ¾Ğº: ${d.count}</div>
    <div class="sql-res"><table><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function fmtM(v) {
  return (+(v||0)).toLocaleString('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0});
}

function fmtD(s) {
  if (!s) return 'â€”';
  return new Date(s).toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'});
}

function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function pagination(page, total, varName, fn) {
  if (total <= 1) return '';
  const pages = [];
  const start = Math.max(1, page-2), end = Math.min(total, page+2);
  if (start > 1) pages.push(`<button class="pb" onclick="${varName}=1;${fn}()">1</button>${start>2?'<span class="ptxt">â€¦</span>':''}`);
  for (let i=start; i<=end; i++) pages.push(`<button class="pb ${i===page?'on':''}" onclick="${varName}=${i};${fn}()">${i}</button>`);
  if (end < total) pages.push(`${end<total-1?'<span class="ptxt">â€¦</span>':''}<button class="pb" onclick="${varName}=${total};${fn}()">${total}</button>`);
  return `<div class="pg">
    <button class="pb" onclick="${varName}=Math.max(1,${page}-1);${fn}()" ${page<=1?'disabled':''}>â†</button>
    ${pages.join('')}
    <button class="pb" onclick="${varName}=Math.min(${total},${page}+1);${fn}()" ${page>=total?'disabled':''}>â†’</button>
  </div>`;
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkAuth();
</script>
</body>
</html>
