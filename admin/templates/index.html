<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VPN Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
/* ‚îÄ‚îÄ Design tokens ‚îÄ‚îÄ */
:root {
  --bg:    #09090e;
  --s1:    #0f1117;
  --s2:    #161820;
  --s3:    #1c1f2b;
  --b:     #21253a;
  --b2:    #2a2f45;
  --acc:   #6366f1;
  --acc2:  rgba(99,102,241,.14);
  --grn:   #10b981;
  --grn2:  rgba(16,185,129,.12);
  --ylw:   #f59e0b;
  --ylw2:  rgba(245,158,11,.12);
  --red:   #ef4444;
  --red2:  rgba(239,68,68,.12);
  --txt:   #e8eaf0;
  --txt2:  #9197ae;
  --txt3:  #555e7a;
  --r:     10px;
  --r2:    14px;
  --side:  220px;
  --trans: .18s ease;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body {
  background: var(--bg);
  color: var(--txt);
  font: 13.5px/1.55 'Inter', system-ui, sans-serif;
  -webkit-font-smoothing: antialiased;
}
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--b2); border-radius: 8px; }

/* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
#login {
  display: flex; align-items: center; justify-content: center;
  height: 100vh;
  background: radial-gradient(ellipse 70% 50% at 50% -5%, #1a1960 0%, var(--bg) 70%);
}
.lcard {
  background: var(--s1); border: 1px solid var(--b);
  border-radius: 20px; padding: 44px 36px;
  width: min(380px, 92vw); text-align: center;
  box-shadow: 0 40px 80px rgba(0,0,0,.55), 0 0 0 1px rgba(99,102,241,.08);
}
.lcard-ico { font-size: 46px; line-height: 1; margin-bottom: 16px; }
.lcard h1 { font-size: 21px; font-weight: 700; margin-bottom: 6px; }
.lcard p  { color: var(--txt2); font-size: 13px; margin-bottom: 28px; }
.linput {
  width: 100%; padding: 12px 14px;
  background: var(--s2); border: 1px solid var(--b);
  border-radius: 9px; color: var(--txt); font: inherit;
  font-size: 14px; outline: none; margin-bottom: 10px;
  transition: border-color var(--trans);
}
.linput:focus { border-color: var(--acc); }
.lbtn {
  width: 100%; padding: 13px; background: var(--acc);
  color: #fff; border: none; border-radius: 9px;
  font: 600 14px 'Inter', system-ui;
  cursor: pointer; transition: opacity var(--trans), transform var(--trans);
}
.lbtn:hover { opacity: .88; }
.lbtn:active { transform: scale(.99); }
.lerr { color: var(--red); font-size: 12px; margin-top: 10px; min-height: 18px; }

/* ‚îÄ‚îÄ App shell ‚îÄ‚îÄ */
#app { display: none; height: 100vh; overflow: hidden; }
.shell { display: flex; height: 100vh; overflow: hidden; }

/* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
.side {
  width: var(--side); flex-shrink: 0;
  background: var(--s1); border-right: 1px solid var(--b);
  display: flex; flex-direction: column;
  transition: transform .24s ease; z-index: 50;
}
.brand {
  padding: 20px 16px 16px;
  display: flex; align-items: center; gap: 10px;
  border-bottom: 1px solid var(--b);
}
.brand-ico  { font-size: 26px; flex-shrink: 0; }
.brand-name { font-size: 14px; font-weight: 700; }
.brand-sub  { font-size: 9px; color: var(--txt3); letter-spacing: .1em; text-transform: uppercase; margin-top: 1px; }
nav { flex: 1; padding: 10px 8px; overflow-y: auto; }
.nav-sec {
  font-size: 9px; color: var(--txt3); text-transform: uppercase;
  letter-spacing: .1em; padding: 14px 9px 5px;
}
.ni {
  display: flex; align-items: center; gap: 9px;
  padding: 9px 10px; border-radius: 8px;
  cursor: pointer; color: var(--txt2);
  font-size: 13px; font-weight: 500;
  transition: background var(--trans), color var(--trans);
  margin-bottom: 1px; white-space: nowrap;
}
.ni:hover { background: var(--s2); color: var(--txt); }
.ni.on    { background: var(--acc2); color: var(--acc); }
.ni .ic   { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.side-foot { padding: 12px 10px; border-top: 1px solid var(--b); }
.out-btn {
  width: 100%; padding: 9px 12px; border-radius: 8px;
  background: transparent; border: 1px solid var(--b);
  color: var(--txt2); cursor: pointer;
  font: 12px 'Inter', system-ui;
  transition: border-color var(--trans), color var(--trans);
  display: flex; align-items: center; justify-content: center; gap: 6px;
}
.out-btn:hover { border-color: var(--red); color: var(--red); }

/* ‚îÄ‚îÄ Mobile overlay ‚îÄ‚îÄ */
.side-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.6); z-index: 40; }

/* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
.main { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
.topbar {
  padding: 11px 18px;
  background: var(--s1); border-bottom: 1px solid var(--b);
  display: flex; align-items: center; gap: 12px; flex-shrink: 0;
}
.menu-btn {
  display: none; background: none; border: none;
  color: var(--txt); font-size: 18px; cursor: pointer;
  padding: 2px 6px; line-height: 1; flex-shrink: 0;
}
.topbar h1 { font-size: 15px; font-weight: 600; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.status-dot {
  display: flex; align-items: center; gap: 5px;
  background: var(--grn2); color: var(--grn);
  border-radius: 20px; padding: 4px 11px;
  font-size: 11px; font-weight: 600; flex-shrink: 0;
}
.status-dot::before { content: ''; width: 6px; height: 6px; background: var(--grn); border-radius: 50%; }
.view { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }

/* ‚îÄ‚îÄ Stats grid ‚îÄ‚îÄ */
.sg { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 12px; margin-bottom: 18px; }
.sc {
  background: var(--s1); border: 1px solid var(--b);
  border-radius: var(--r2); padding: 18px 16px;
  position: relative; overflow: hidden;
  transition: border-color var(--trans);
}
.sc:hover { border-color: var(--b2); }
.sc::before {
  content: ''; position: absolute;
  top: 0; left: 0; right: 0; height: 2px; border-radius: 2px 2px 0 0;
}
.sc.p::before { background: var(--acc); }
.sc.g::before { background: var(--grn); }
.sc.y::before { background: var(--ylw); }
.sc.r::before { background: var(--red); }
.sc-emoji { width: 36px; height: 36px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; border-radius: 9px; background: var(--s2); }
.sl { font-size: 10px; color: var(--txt3); text-transform: uppercase; letter-spacing: .07em; margin-bottom: 6px; }
.sv { font-size: 26px; font-weight: 700; letter-spacing: -.5px; margin-bottom: 3px; }
.ss { font-size: 11px; color: var(--txt2); }

/* ‚îÄ‚îÄ Charts ‚îÄ‚îÄ */
.cg { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 18px; }
.cc { background: var(--s1); border: 1px solid var(--b); border-radius: var(--r2); padding: 18px; }
.ct { font-size: 12px; font-weight: 600; color: var(--txt2); margin-bottom: 14px; }

/* ‚îÄ‚îÄ Table card ‚îÄ‚îÄ */
.tc { background: var(--s1); border: 1px solid var(--b); border-radius: var(--r2); overflow: hidden; }
.tb { padding: 14px 16px; border-bottom: 1px solid var(--b); display: flex; flex-direction: column; gap: 10px; }
.tb-top { display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
.tb-top h2 { font-size: 14px; font-weight: 600; white-space: nowrap; }
.tb-count { color: var(--txt3); font-size: 13px; font-weight: 400; margin-left: 6px; }
.tb-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

/* ‚îÄ‚îÄ Filter panel ‚îÄ‚îÄ */
.fp {
  background: var(--s2); border: 1px solid var(--b); border-radius: var(--r);
  padding: 14px; display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end;
}
.fg { display: flex; flex-direction: column; gap: 5px; min-width: 0; }
.fg label { font-size: 10px; color: var(--txt3); text-transform: uppercase; letter-spacing: .07em; }
.date-range { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
.date-range span { font-size: 11px; color: var(--txt3); }

/* ‚îÄ‚îÄ Form controls ‚îÄ‚îÄ */
.si, .fsel, .di {
  background: var(--s2); border: 1px solid var(--b);
  border-radius: 8px; color: var(--txt); font: inherit;
  outline: none; transition: border-color var(--trans); -webkit-appearance: none;
}
.si   { padding: 8px 11px; font-size: 13px; }
.fsel { padding: 8px 11px; font-size: 13px; cursor: pointer; }
.di   { padding: 7px 10px; font-size: 12px; cursor: pointer; }
.si:focus, .fsel:focus, .di:focus { border-color: var(--acc); }
.di::-webkit-calendar-picker-indicator { filter: invert(.4); cursor: pointer; }

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn {
  padding: 7px 13px; border-radius: 8px; border: none;
  cursor: pointer; font: 600 12.5px 'Inter', system-ui;
  transition: all var(--trans);
  display: inline-flex; align-items: center; gap: 5px;
  white-space: nowrap; -webkit-tap-highlight-color: transparent;
}
.btn:disabled { opacity: .38; cursor: not-allowed; }
.btn:not(:disabled):active { transform: scale(.97); }
.btn-acc  { background: var(--acc2); color: var(--acc); border: 1px solid rgba(99,102,241,.25); }
.btn-acc:hover:not(:disabled)  { background: rgba(99,102,241,.22); }
.btn-grn  { background: var(--grn2); color: var(--grn); border: 1px solid rgba(16,185,129,.25); }
.btn-grn:hover:not(:disabled)  { background: rgba(16,185,129,.2); }
.btn-red  { background: var(--red2); color: var(--red); border: 1px solid rgba(239,68,68,.25); }
.btn-red:hover:not(:disabled)  { background: rgba(239,68,68,.2); }
.btn-d    { background: transparent; color: var(--txt2); border: 1px solid var(--b); }
.btn-d:hover:not(:disabled)    { color: var(--txt); border-color: var(--b2); }
.btn-primary { background: var(--acc); color: #fff; border: 1px solid var(--acc); }
.btn-primary:hover:not(:disabled) { opacity: .88; }
.btn-lg   { padding: 11px 22px; font-size: 13.5px; border-radius: 9px; }
.btn-sm   { padding: 5px 10px; font-size: 11.5px; border-radius: 6px; }
.btn-icon { padding: 7px 9px; }
.btn-full { width: 100%; justify-content: center; }

/* ‚îÄ‚îÄ Search ‚îÄ‚îÄ */
.search-wrap { display: flex; gap: 6px; flex: 1; min-width: 0; }
.search-wrap .si { flex: 1; min-width: 0; }

/* ‚îÄ‚îÄ Filter toggle ‚îÄ‚îÄ */
.ftgl {
  display: flex; align-items: center; gap: 5px;
  padding: 7px 12px; border-radius: 8px;
  border: 1px solid var(--b); background: transparent;
  color: var(--txt2); cursor: pointer;
  font: 500 12.5px 'Inter', system-ui;
  transition: all var(--trans); white-space: nowrap; flex-shrink: 0;
}
.ftgl:hover, .ftgl.on { border-color: var(--acc); color: var(--acc); background: var(--acc2); }
.f-count { background: var(--acc); color: #fff; border-radius: 10px; padding: 1px 6px; font-size: 9.5px; margin-left: 2px; }

/* ‚îÄ‚îÄ Filter chips ‚îÄ‚îÄ */
.af-chips { display: flex; gap: 6px; flex-wrap: wrap; }
.afc {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 3px 10px; background: var(--acc2);
  border: 1px solid rgba(99,102,241,.2);
  border-radius: 20px; font-size: 11px; color: var(--acc); white-space: nowrap;
}
.afc button { background: none; border: none; color: var(--acc); cursor: pointer; font-size: 12px; padding: 0; line-height: 1; opacity: .6; margin-left: 2px; }
.afc button:hover { opacity: 1; }

/* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
.table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
table { width: 100%; border-collapse: collapse; min-width: 480px; }
thead th {
  font-size: 10px; color: var(--txt3);
  text-transform: uppercase; letter-spacing: .07em;
  padding: 10px 14px; text-align: left;
  border-bottom: 1px solid var(--b); white-space: nowrap;
  background: var(--s2);
}
td {
  padding: 11px 14px; font-size: 12.5px;
  border-bottom: 1px solid rgba(30,33,52,.7); vertical-align: middle;
}
tr:last-child td { border-bottom: none; }
tbody tr { transition: background var(--trans); }
tbody tr:hover td { background: rgba(255,255,255,.017); }
.empty-row td { text-align: center; color: var(--txt3); padding: 44px; font-size: 13px; }

/* ‚îÄ‚îÄ Badges ‚îÄ‚îÄ */
.bd {
  display: inline-flex; align-items: center; border-radius: 20px;
  padding: 2px 9px; font-size: 10px; font-weight: 600; white-space: nowrap;
}
.bd.g { background: var(--grn2); color: var(--grn); }
.bd.r { background: var(--red2); color: var(--red); }
.bd.y { background: var(--ylw2); color: var(--ylw); }
.bd.p { background: var(--acc2); color: var(--acc); }
.bd.d { background: rgba(100,116,139,.1); color: var(--txt2); }

.acts     { display: flex; gap: 4px; flex-wrap: nowrap; }
.sub-col  { display: flex; flex-direction: column; gap: 2px; }
.sub-days { font-size: 10px; color: var(--txt3); }

/* ‚îÄ‚îÄ Pagination ‚îÄ‚îÄ */
.pg { display: flex; align-items: center; justify-content: center; gap: 4px; padding: 14px; flex-wrap: wrap; }
.pb {
  padding: 5px 11px; background: var(--s2); border: 1px solid var(--b);
  border-radius: 7px; color: var(--txt2); cursor: pointer;
  font: 12px 'Inter', system-ui; transition: all var(--trans);
  -webkit-tap-highlight-color: transparent;
}
.pb:hover { border-color: var(--acc); color: var(--acc); }
.pb.on    { background: var(--acc); border-color: var(--acc); color: #fff; }
.pb:disabled { opacity: .3; cursor: not-allowed; }
.ptxt { font-size: 12px; color: var(--txt3); padding: 0 3px; }

/* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
.ov {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.72); z-index: 200;
  display: flex; align-items: flex-end; justify-content: center;
  backdrop-filter: blur(4px); padding: 0;
  animation: fadeIn .15s ease;
}
@keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
.mo {
  background: var(--s1); border: 1px solid var(--b);
  border-radius: 18px 18px 0 0;
  padding: 22px 22px 32px; width: 100%;
  max-width: 580px; max-height: 90vh;
  overflow-y: auto; box-shadow: 0 -12px 50px rgba(0,0,0,.45);
  animation: slideUp .18s ease;
}
@keyframes slideUp { from { transform: translateY(20px); opacity: .6 } to { transform: none; opacity: 1 } }
.mo-handle { width: 36px; height: 3px; background: var(--b2); border-radius: 4px; margin: 0 auto 18px; }
.mo-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 18px; }
.mo-title { font-size: 16px; font-weight: 700; }
.mo-sub   { font-size: 12px; color: var(--txt2); margin-top: 2px; }
.mo-x {
  background: var(--s2); border: 1px solid var(--b);
  color: var(--txt2); cursor: pointer; border-radius: 7px;
  width: 28px; height: 28px; display: flex; align-items: center;
  justify-content: center; font-size: 14px; flex-shrink: 0;
  transition: all var(--trans);
}
.mo-x:hover { border-color: var(--txt2); color: var(--txt); }
.ir {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 0; border-bottom: 1px solid rgba(30,33,52,.9);
  font-size: 13px; gap: 12px;
}
.ir:last-child { border-bottom: none; }
.il { color: var(--txt2); flex-shrink: 0; }
.iv { font-weight: 500; max-width: 260px; word-break: break-all; text-align: right; font-size: 12px; }
.mo-act { display: flex; gap: 8px; margin-top: 22px; flex-wrap: wrap; }
.mo-sect {
  font-size: 10px; font-weight: 600; color: var(--txt3);
  margin: 18px 0 9px; text-transform: uppercase; letter-spacing: .07em;
}
.mini-t {
  width: 100%; border-collapse: collapse;
  border: 1px solid var(--b); border-radius: 8px; overflow: hidden;
  font-size: 11.5px;
}
.mini-t th {
  font-size: 9.5px; color: var(--txt3); text-transform: uppercase;
  padding: 8px 10px; background: var(--s2); text-align: left; letter-spacing: .05em;
}
.mini-t td { padding: 8px 10px; border-top: 1px solid var(--b); }

/* ‚îÄ‚îÄ Confirm modal ‚îÄ‚îÄ */
.confirm-ico { display: flex; align-items: center; justify-content: center; margin-bottom: 14px; }
.confirm-ico svg { width: 48px; height: 48px; }
.confirm-ico.ico-grn svg { color: var(--grn); }
.confirm-ico.ico-acc svg { color: var(--acc); }
.confirm-ico.ico-red svg { color: var(--red); }
.confirm-ico.ico-txt svg { color: var(--txt2); }
.confirm-msg { text-align: center; color: var(--txt2); font-size: 13px; margin-bottom: 22px; line-height: 1.7; }
.mo-btns { display: flex; gap: 10px; justify-content: center; }
.chk-row {
  display: flex; align-items: center; gap: 9px;
  justify-content: center; font-size: 12.5px; color: var(--txt2);
  margin-bottom: 20px; cursor: pointer;
}
.chk-row input { accent-color: var(--acc); width: 14px; height: 14px; cursor: pointer; }

/* ‚îÄ‚îÄ Adjust subscription modal ‚îÄ‚îÄ */
.adj-tabs { display: flex; gap: 2px; background: var(--s2); border-radius: 10px; padding: 3px; margin-bottom: 20px; }
.adj-tab {
  flex: 1; padding: 8px; text-align: center; border-radius: 8px;
  font: 600 12.5px 'Inter', system-ui; cursor: pointer;
  color: var(--txt2); border: none; background: transparent;
  transition: all var(--trans);
}
.adj-tab.on { background: var(--s1); color: var(--txt); box-shadow: 0 1px 4px rgba(0,0,0,.3); }
.adj-pane { display: none; }
.adj-pane.on { display: block; }

.adj-slider-wrap { padding: 8px 0 4px; }
.adj-slider {
  -webkit-appearance: none; appearance: none;
  width: 100%; height: 5px; border-radius: 5px;
  outline: none; cursor: pointer;
  background: linear-gradient(to right, var(--acc) var(--pct, 50%), var(--b2) var(--pct, 50%));
}
.adj-slider::-webkit-slider-thumb {
  -webkit-appearance: none; appearance: none;
  width: 20px; height: 20px; border-radius: 50%;
  background: var(--acc); cursor: pointer;
  box-shadow: 0 0 0 3px var(--acc2), 0 2px 6px rgba(0,0,0,.4);
  transition: box-shadow .15s;
}
.adj-slider::-webkit-slider-thumb:hover { box-shadow: 0 0 0 5px var(--acc2), 0 2px 8px rgba(0,0,0,.5); }
.adj-slider-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--txt3); margin-top: 6px; }
.adj-days-display {
  text-align: center; margin: 14px 0 6px;
  font-size: 28px; font-weight: 700; line-height: 1;
  transition: color .15s;
}
.adj-days-display.neg { color: var(--red); }
.adj-days-display.pos { color: var(--grn); }
.adj-days-display.zer { color: var(--txt2); }
.adj-days-suffix { text-align: center; font-size: 11px; color: var(--txt3); margin-bottom: 4px; }

.adj-preview {
  background: var(--s2); border: 1px solid var(--b); border-radius: 10px;
  padding: 13px 16px; margin: 14px 0;
  display: flex; justify-content: space-between; align-items: center;
}
.adj-preview-label { font-size: 11px; color: var(--txt3); margin-bottom: 3px; }
.adj-preview-val { font-size: 13px; font-weight: 600; }
.adj-preview-arrow { color: var(--txt3); padding: 0 8px; }
.adj-preview-arrow svg { width: 16px; height: 16px; vertical-align: middle; }
.adj-new { color: var(--acc); }

.adj-date-field {
  width: 100%; padding: 11px 14px;
  background: var(--s2); border: 1px solid var(--b);
  border-radius: 9px; color: var(--txt);
  font: 14px 'Inter', system-ui;
  outline: none; transition: border-color var(--trans);
}
.adj-date-field:focus { border-color: var(--acc); }
.adj-date-field::-webkit-calendar-picker-indicator { filter: invert(.4); cursor: pointer; }
.adj-date-note { font-size: 11px; color: var(--txt3); margin-top: 8px; }
.adj-warn { color: var(--ylw); font-size: 11.5px; margin-top: 8px; display: flex; align-items: center; gap: 5px; }
.adj-warn svg { width: 14px; height: 14px; flex-shrink: 0; }

/* ‚îÄ‚îÄ Broadcast ‚îÄ‚îÄ */
.bpage { max-width: 660px; }
.bpage h2 { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
.bpage .hint { color: var(--txt2); font-size: 12.5px; margin-bottom: 20px; }
.bcast-ta {
  width: 100%; min-height: 130px;
  background: var(--s2); border: 1px solid var(--b); border-radius: 10px;
  padding: 13px; color: var(--txt); font: 13.5px 'Inter', system-ui;
  outline: none; resize: vertical;
  transition: border-color var(--trans); margin-bottom: 16px; line-height: 1.55;
}
.bcast-ta:focus { border-color: var(--acc); }
.aud-label { font-size: 10px; color: var(--txt3); text-transform: uppercase; letter-spacing: .08em; margin-bottom: 10px; }
.aud-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap: 8px; margin-bottom: 18px; }
.aud-card {
  padding: 13px 14px; background: var(--s2);
  border: 1.5px solid var(--b); border-radius: 10px;
  cursor: pointer; transition: all var(--trans);
}
.aud-card:hover { border-color: var(--b2); }
.aud-card.sel   { border-color: var(--acc); background: var(--acc2); }
.aud-name  { font-size: 13px; font-weight: 600; margin-bottom: 3px; }
.aud-desc  { font-size: 11px; color: var(--txt2); line-height: 1.4; }
.aud-count { font-size: 12px; font-weight: 700; color: var(--acc); margin-top: 6px; }
.bcast-footer { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }
.bcast-total  { font-size: 13px; color: var(--txt2); }
.bcast-total b { color: var(--txt); }
.bcast-ok {
  margin-top: 14px; padding: 13px 16px;
  background: var(--grn2); border: 1px solid rgba(16,185,129,.22);
  border-radius: 9px; color: var(--grn); font-size: 13.5px;
}

/* ‚îÄ‚îÄ Loading / toast ‚îÄ‚îÄ */
.ld { display: flex; align-items: center; justify-content: center; padding: 56px; color: var(--txt2); gap: 10px; }
.sp { width: 17px; height: 17px; border: 2px solid var(--b2); border-top-color: var(--acc); border-radius: 50%; animation: spin .65s linear infinite; flex-shrink: 0; }
@keyframes spin { to { transform: rotate(360deg) } }
#toast {
  position: fixed; bottom: 20px; right: 16px;
  background: var(--s2); border: 1px solid var(--b); border-radius: 10px;
  padding: 11px 18px; font-size: 13px; z-index: 999;
  transform: translateY(70px); opacity: 0;
  transition: all .24s ease; pointer-events: none;
  max-width: calc(100vw - 32px); box-shadow: 0 8px 24px rgba(0,0,0,.3);
}
#toast.show { transform: translateY(0); opacity: 1; }
#toast.ok  { border-color: rgba(16,185,129,.4); color: var(--grn); }
#toast.err { border-color: rgba(239,68,68,.4);  color: var(--red); }

/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
@media (max-width: 680px) {
  .side { position: fixed; top: 0; left: 0; bottom: 0; transform: translateX(-100%); }
  .side.open { transform: translateX(0); }
  .side-overlay { display: block; }
  .menu-btn { display: block; }
  .cg { grid-template-columns: 1fr; }
  .sg { grid-template-columns: repeat(2, 1fr); }
  .tb-top { flex-direction: column; align-items: flex-start; }
  .search-wrap .si { font-size: 16px; }
  .view { padding: 12px; }
  table { min-width: 400px; }
  .aud-grid { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 400px) {
  .sg { grid-template-columns: 1fr 1fr; }
  .aud-grid { grid-template-columns: 1fr; }
}
@media (min-width: 681px) {
  .ov { align-items: center; padding: 20px; }
  .mo { border-radius: 16px; max-height: 84vh; }
  .mo-handle { display: none; }
}
</style>
</head>
<body>

<!-- Login -->
<div id="login">
  <div class="lcard">
    <div class="lcard-ico"><svg width="46" height="46" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color:var(--acc)"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
    <h1>VPN Admin</h1>
    <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –ø–∞–Ω–µ–ª—å</p>
    <input class="linput" type="password" id="pw" placeholder="–ü–∞—Ä–æ–ª—å"
      onkeydown="if(event.key==='Enter')doLogin()">
    <button class="lbtn" onclick="doLogin()">–í–æ–π—Ç–∏</button>
    <div class="lerr" id="lerr"></div>
  </div>
</div>

<!-- App -->
<div id="app">
<div class="shell">
  <div class="side-overlay" id="sov" onclick="closeSidebar()" style="display:none"></div>
  <aside class="side" id="sidebar">
    <div class="brand">
      <div class="brand-ico">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" style="color:var(--acc)"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      </div>
      <div>
        <div class="brand-name">VPN Admin</div>
        <div class="brand-sub">Panel</div>
      </div>
    </div>
    <nav>
      <div class="nav-sec">–û–±–∑–æ—Ä</div>
      <div class="ni on" data-p="dash"      onclick="go('dash')">
        <span class="ic"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg></span>
        –î–∞—à–±–æ—Ä–¥
      </div>
      <div class="nav-sec">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</div>
      <div class="ni" data-p="users"     onclick="go('users')">
        <span class="ic"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></span>
        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
      </div>
      <div class="ni" data-p="payments"  onclick="go('payments')">
        <span class="ic"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></span>
        –ü–ª–∞—Ç–µ–∂–∏
      </div>
      <div class="nav-sec">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
      <div class="ni" data-p="broadcast" onclick="go('broadcast')">
        <span class="ic"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 11l19-9-9 19-2-8-8-2z"/></svg></span>
        –†–∞—Å—Å—ã–ª–∫–∞
      </div>
    </nav>
    <div class="side-foot">
      <button class="out-btn" onclick="doLogout()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        –í—ã–π—Ç–∏
      </button>
    </div>
  </aside>

  <div class="main">
    <div class="topbar">
      <button class="menu-btn" onclick="openSidebar()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
      <h1 id="ptitle">–î–∞—à–±–æ—Ä–¥</h1>
      <span class="status-dot">–û–Ω–ª–∞–π–Ω</span>
    </div>
    <div class="view" id="view">
      <div class="ld"><div class="sp"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>
</div>
</div>

<!-- Modal -->
<div class="ov" id="modal" style="display:none" onclick="if(event.target===this)closeMo()">
  <div class="mo" id="mo-body"></div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CORE UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const $ = id => document.getElementById(id);
let _charts = {};

async function api(path, opts = {}) {
  const r = await fetch('/api' + path, {
    headers: {'Content-Type': 'application/json'},
    ...opts,
    body: opts.body !== undefined ? JSON.stringify(opts.body) : undefined,
  });
  return r.json();
}

function toast(msg, type = 'ok') {
  const el = $('toast');
  el.textContent = msg;
  el.className = `show ${type}`;
  clearTimeout(window._tt);
  window._tt = setTimeout(() => el.className = '', 3200);
}

function openMo(html) { $('mo-body').innerHTML = html; $('modal').style.display = 'flex'; }
function closeMo()    { $('modal').style.display = 'none'; }

function openSidebar() {
  $('sidebar').classList.add('open');
  $('sov').style.display = 'block';
  document.body.style.overflow = 'hidden';
}
function closeSidebar() {
  $('sidebar').classList.remove('open');
  $('sov').style.display = 'none';
  document.body.style.overflow = '';
}

function esc(s) {
  return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function fmtM(v) {
  return (+(v||0)).toLocaleString('ru-RU', {style:'currency', currency:'RUB', maximumFractionDigits:0});
}
function fmtD(s) {
  if (!s) return '‚Äî';
  return new Date(s).toLocaleString('ru-RU',
    {day:'2-digit', month:'2-digit', year:'2-digit', hour:'2-digit', minute:'2-digit'});
}
function fmtDate(s) {
  if (!s) return '‚Äî';
  return new Date(s).toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit', year:'numeric'});
}
function today()    { return new Date().toISOString().slice(0, 10); }
function btnLoad(id){ const el = $(id); if (el) { el.innerHTML = '<div class="sp" style="width:14px;height:14px;border-width:2px;display:inline-block;vertical-align:middle"></div>'; el.disabled = true; } }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function checkAuth() {
  const d = await api('/me');
  d.logged_in ? showApp() : ($('login').style.display = 'flex');
}
async function doLogin() {
  const d = await api('/login', {method:'POST', body:{password: $('pw').value}});
  d.ok ? showApp() : ($('lerr').textContent = d.error || '–û—à–∏–±–∫–∞');
}
async function doLogout() {
  await api('/logout', {method:'POST'});
  $('app').style.display = 'none';
  $('login').style.display = 'flex';
  $('pw').value = '';
}
function showApp() {
  $('login').style.display = 'none';
  $('app').style.display = 'block';
  go('dash');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const TITLES = {dash:'–î–∞—à–±–æ—Ä–¥', users:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏', payments:'–ü–ª–∞—Ç–µ–∂–∏', broadcast:'–†–∞—Å—Å—ã–ª–∫–∞'};
const PAGES  = {dash:renderDash, users:renderUsers, payments:renderPayments, broadcast:renderBroadcast};

function go(page) {
  closeSidebar();
  document.querySelectorAll('.ni').forEach(el => el.classList.toggle('on', el.dataset.p === page));
  $('ptitle').textContent = TITLES[page] || page;
  (PAGES[page] || (() => {}))();
}
function setView(html) { $('view').innerHTML = html; }
function loading()     { setView('<div class="ld"><div class="sp"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function renderDash() {
  loading();
  const d = await api('/stats');
  setView(`
    <div class="sg">
      <div class="sc p">
        <div class="sc-emoji"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" style="color:var(--acc)"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
        <div class="sl">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        <div class="sv">${d.total_users}</div>
        <div class="ss">+${d.new_today} –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
      </div>
      <div class="sc g">
        <div class="sc-emoji"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" style="color:var(--grn)"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9 12 11 14 15 10"/></svg></div>
        <div class="sl">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</div>
        <div class="sv">${d.active_subs}</div>
        <div class="ss">${d.expiring} –∏—Å—Ç–µ–∫–∞—é—Ç —Å–∫–æ—Ä–æ</div>
      </div>
      <div class="sc y">
        <div class="sc-emoji"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" style="color:var(--ylw)"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
        <div class="sl">–í—ã—Ä—É—á–∫–∞ –∑–∞ –º–µ—Å—è—Ü</div>
        <div class="sv">${fmtM(d.revenue_month)}</div>
        <div class="ss">–í—Å–µ–≥–æ ${fmtM(d.revenue_total)}</div>
      </div>
      <div class="sc r">
        <div class="sc-emoji"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" style="color:var(--red)"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg></div>
        <div class="sl">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
        <div class="sv">${d.banned}</div>
        <div class="ss">–ò–∑ ${d.total_users} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
      </div>
    </div>
    <div class="cg">
      <div class="cc"><div class="ct">–í—ã—Ä—É—á–∫–∞, 14 –¥–Ω–µ–π</div><canvas id="cr" height="130"></canvas></div>
      <div class="cc"><div class="ct">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, 14 –¥–Ω–µ–π</div><canvas id="crg" height="130"></canvas></div>
    </div>`);
  mkChart('cr',  d.revenue_chart, '#6366f1');
  mkChart('crg', d.reg_chart,     '#10b981');
}

function mkChart(id, data, color) {
  if (_charts[id]) _charts[id].destroy();
  _charts[id] = new Chart($(id), {
    type: 'line',
    data: {
      labels: data.map(r => String(r.day ?? '').slice(5)),
      datasets: [{
        data: data.map(r => r.total),
        borderColor: color, backgroundColor: color + '18',
        fill: true, tension: .4, pointRadius: 3, pointBackgroundColor: color,
      }],
    },
    options: {
      responsive: true, plugins: {legend:{display:false}},
      scales: {
        x: {grid:{color:'#21253a66'}, ticks:{color:'#555e7a', font:{size:10}}},
        y: {grid:{color:'#21253a66'}, ticks:{color:'#555e7a', font:{size:10}}},
      },
    },
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USERS ‚Äî list & filters
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const uF = {
  page:1, search:'', pendingSearch:'',
  sub_status:'', banned:'', reg_from:'', reg_to:'', sub_from:'', sub_to:'',
  showFilters: false,
};

async function renderUsers() {
  loading();
  const p = new URLSearchParams({
    page:uF.page, per_page:25,
    search:uF.search, sub_status:uF.sub_status, banned:uF.banned,
    reg_from:uF.reg_from, reg_to:uF.reg_to, sub_from:uF.sub_from, sub_to:uF.sub_to,
  });
  const d  = await api('/users?' + p);
  const tp = Math.ceil(d.total / 25);

  setView(`
    <div class="tc">
      <div class="tb">
        <div class="tb-top">
          <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ <span class="tb-count">${d.total}</span></h2>
          <div class="tb-row">
            <div class="search-wrap">
              <input class="si" id="usrch" placeholder="üîç –ò–º—è, @username –∏–ª–∏ ID"
                value="${esc(uF.pendingSearch)}"
                onkeydown="if(event.key==='Enter'){commitSearch();renderUsers()}">
              <button class="btn btn-acc btn-sm" onclick="commitSearch();renderUsers()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> –ù–∞–π—Ç–∏</button>
            </div>
            <button class="ftgl ${uF.showFilters?'on':''}"
              onclick="uF.showFilters=!uF.showFilters;renderUsers()">
              ‚öô –§–∏–ª—å—Ç—Ä—ã${countF()?`<span class="f-count">${countF()}</span>`:''}
            </button>
            ${countF()?`<button class="btn btn-d btn-sm" onclick="resetF()">${_svg('x','11')}</button>`:''}
            <button class="btn btn-d btn-icon" title="–û–±–Ω–æ–≤–∏—Ç—å" onclick="renderUsers()">${_svg('refresh','13')}</button>
          </div>
        </div>
        ${uF.showFilters ? renderFilterPanel() : ''}
        ${buildChips() ? `<div class="af-chips">${buildChips()}</div>` : ''}
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ü–æ–¥–ø–∏—Å–∫–∞</th>
            <th>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</th><th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</th><th></th>
          </tr></thead>
          <tbody>
            ${d.users.map(userRow).join('') ||
              '<tr class="empty-row"><td colspan="6">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>'}
          </tbody>
        </table>
      </div>
      ${mkPager(uF.page, tp, 'uF.page', 'renderUsers')}
    </div>`);
}

function renderFilterPanel() {
  return `
    <div class="fp">
      <div class="fg">
        <label>–ü–æ–¥–ø–∏—Å–∫–∞</label>
        <select class="fsel" onchange="uF.sub_status=this.value;uF.page=1;renderUsers()">
          <option value="">–õ—é–±–∞—è</option>
          <option value="active"   ${uF.sub_status==='active'  ?'selected':''}>–ê–∫—Ç–∏–≤–Ω–∞—è</option>
          <option value="expiring" ${uF.sub_status==='expiring'?'selected':''}>–ò—Å—Ç–µ–∫–∞–µ—Ç (3 –¥–Ω—è)</option>
          <option value="expired"  ${uF.sub_status==='expired' ?'selected':''}>–ò—Å—Ç–µ–∫–ª–∞</option>
          <option value="no_sub"   ${uF.sub_status==='no_sub'  ?'selected':''}>–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏</option>
        </select>
      </div>
      <div class="fg">
        <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
        <select class="fsel" onchange="uF.banned=this.value;uF.page=1;renderUsers()">
          <option value="">–í—Å–µ</option>
          <option value="false" ${uF.banned==='false'?'selected':''}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
          <option value="true"  ${uF.banned==='true' ?'selected':''}>–ó–∞–±–∞–Ω–µ–Ω–Ω—ã–µ</option>
        </select>
      </div>
      <div class="fg">
        <label>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label>
        <div class="date-range">
          <input type="date" class="di" value="${uF.reg_from}" max="${today()}"
            onchange="uF.reg_from=this.value;uF.page=1;renderUsers()">
          <span>‚Äî</span>
          <input type="date" class="di" value="${uF.reg_to}" max="${today()}"
            onchange="uF.reg_to=this.value;uF.page=1;renderUsers()">
        </div>
      </div>
      <div class="fg">
        <label>–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏</label>
        <div class="date-range">
          <input type="date" class="di" value="${uF.sub_from}" max="${today()}"
            onchange="uF.sub_from=this.value;uF.page=1;renderUsers()">
          <span>‚Äî</span>
          <input type="date" class="di" value="${uF.sub_to}" max="${today()}"
            onchange="uF.sub_to=this.value;uF.page=1;renderUsers()">
        </div>
      </div>
      <div class="fg" style="justify-content:flex-end;margin-top:auto">
        <button class="btn btn-d btn-sm"
          onclick="uF.reg_from=today();uF.reg_to=today();uF.page=1;renderUsers()">
          –°–µ–≥–æ–¥–Ω—è
        </button>
      </div>
    </div>`;
}

function commitSearch() {
  uF.search = $('usrch')?.value ?? '';
  uF.pendingSearch = uF.search;
  uF.page = 1;
}
function countF() {
  return [uF.search, uF.sub_status, uF.banned, uF.reg_from, uF.reg_to, uF.sub_from, uF.sub_to]
    .filter(Boolean).length;
}
function resetF() {
  Object.assign(uF, {page:1, search:'', pendingSearch:'', sub_status:'',
    banned:'', reg_from:'', reg_to:'', sub_from:'', sub_to:''});
  renderUsers();
}
function buildChips() {
  const c = [];
  const ch = (l, cb) => `<span class="afc">${l}<button onclick="${cb}">√ó</button></span>`;
  if (uF.search)
    c.push(ch(`¬´${esc(uF.search)}¬ª`, "uF.search='';uF.pendingSearch='';uF.page=1;renderUsers()"));
  if (uF.sub_status)
    c.push(ch({active:'–ê–∫—Ç–∏–≤–Ω–∞—è',expiring:'–ò—Å—Ç–µ–∫–∞–µ—Ç',expired:'–ò—Å—Ç–µ–∫–ª–∞',no_sub:'–ù–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏'}[uF.sub_status]||uF.sub_status, "uF.sub_status='';uF.page=1;renderUsers()"));
  if (uF.banned)
    c.push(ch(uF.banned==='true'?'–ó–∞–±–∞–Ω–µ–Ω–Ω—ã–µ':'–ê–∫—Ç–∏–≤–Ω—ã–µ', "uF.banned='';uF.page=1;renderUsers()"));
  if (uF.reg_from||uF.reg_to)
    c.push(ch(`–†–µ–≥: ${uF.reg_from||'‚Ä¶'}‚Äì${uF.reg_to||'‚Ä¶'}`, "uF.reg_from='';uF.reg_to='';uF.page=1;renderUsers()"));
  if (uF.sub_from||uF.sub_to)
    c.push(ch(`–ü–æ–∫—É–ø–∫–∞: ${uF.sub_from||'‚Ä¶'}‚Äì${uF.sub_to||'‚Ä¶'}`, "uF.sub_from='';uF.sub_to='';uF.page=1;renderUsers()"));
  return c.join('');
}

function _svg(d, s = '12') {
  const icons = {
    gift:    `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5" rx="1"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>`,
    plus:    `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>`,
    cal:     `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
    stop:    `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="3"/></svg>`,
    ban:     `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><circle cx="12" cy="12" r="9"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>`,
    unban:   `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9 12 11 14 15 10"/></svg>`,
    trash:   `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>`,
    more:    `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>`,
    refresh: `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>`,
    x:       `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
    arrow:   `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>`,
    warn:    `<svg width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
  };
  return icons[d] || '';
}

function userRow(u) {
  const hasActive = u.sub_id && u.sub_active && new Date(u.expires_at) > new Date();
  const hasAny    = !!u.sub_id;
  let subActions = '';
  if (!hasAny || !u.sub_active || new Date(u.expires_at) <= new Date())
    subActions = `<button class="btn btn-grn btn-sm" onclick="confirmGrant(${u.user_id},'${esc(u.first_name)}')">${_svg('gift')} –í—ã–¥–∞—Ç—å</button>`;
  else
    subActions = `<button class="btn btn-acc btn-sm" onclick="confirmExtend(${u.user_id},'${esc(u.first_name)}')">${_svg('plus')} –ü—Ä–æ–¥–ª–∏—Ç—å</button>
                  <button class="btn btn-d btn-sm" onclick="confirmAdjust(${u.user_id},'${esc(u.first_name)}','${u.expires_at||''}')" title="–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ä–æ–∫">${_svg('cal')} –°—Ä–æ–∫</button>`;

  return `<tr>
    <td>
      <div style="font-weight:600">${esc(u.first_name||'‚Äî')}</div>
      <div style="color:var(--txt3);font-size:11px">${u.username?'@'+esc(u.username)+' ':''}<code style="font-size:10px">${u.user_id}</code></div>
    </td>
    <td><span class="bd ${u.is_banned?'r':'g'}">${u.is_banned?'–ó–∞–±–∞–Ω–µ–Ω':'–ê–∫—Ç–∏–≤–µ–Ω'}</span></td>
    <td>${subBadge(u)}</td>
    <td style="white-space:nowrap">${fmtM(u.total_spent)}</td>
    <td style="white-space:nowrap;font-size:11.5px;color:var(--txt2)">${fmtDate(u.registered_at)}</td>
    <td>
      <div class="acts">
        ${subActions}
        <button class="btn btn-d btn-icon btn-sm" onclick="showUser(${u.user_id})" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">${_svg('more')}</button>
      </div>
    </td>
  </tr>`;
}

function subBadge(u) {
  if (!u.sub_id) return '<span class="bd d">–ù–µ—Ç</span>';
  const exp = new Date(u.expires_at), now = new Date();
  if (!u.sub_active || exp <= now) return '<span class="bd r">–ò—Å—Ç–µ–∫–ª–∞</span>';
  const days = Math.ceil((exp - now) / 86400000);
  return `<div class="sub-col"><span class="bd ${days<=3?'y':'g'}">–ê–∫—Ç–∏–≤–Ω–∞</span><span class="sub-days">${days} –¥–Ω.</span></div>`;
}

// ‚îÄ‚îÄ User detail modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function showUser(uid) {
  openMo('<div class="ld"><div class="sp"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>');
  const d = await api('/users/' + uid);
  if (d.error) { closeMo(); toast(d.error, 'err'); return; }
  const u = d.user;
  const hasActive = u.sub_id && u.sub_active && new Date(u.expires_at) > new Date();

  const subRows = d.subscriptions.slice(0,5).map(s => {
    const ok = s.is_active && new Date(s.expires_at) > new Date();
    return `<tr>
      <td>#${s.id}</td>
      <td style="word-break:break-all"><code style="font-size:10px">${esc(s.panel_username)}</code></td>
      <td><span class="bd ${ok?'g':'r'}">${ok?'–ê–∫—Ç–∏–≤–Ω–∞':'–ò—Å—Ç–µ–∫–ª–∞'}</span></td>
      <td style="white-space:nowrap">${fmtD(s.expires_at)}</td>
    </tr>`;
  }).join('') || '<tr><td colspan="4" style="text-align:center;color:var(--txt3);padding:12px">‚Äî</td></tr>';

  const payRows = d.payments.slice(0,5).map(p =>
    `<tr>
      <td><span class="bd ${p.status==='succeeded'?'g':p.status==='pending'?'y':'r'}">${p.status}</span></td>
      <td>${fmtM(p.amount)}</td>
      <td style="white-space:nowrap">${fmtD(p.created_at)}</td>
    </tr>`
  ).join('') || '<tr><td colspan="3" style="text-align:center;color:var(--txt3);padding:12px">‚Äî</td></tr>';

  openMo(`
    <div class="mo-handle"></div>
    <div class="mo-head">
      <div>
        <div class="mo-title">${esc(u.first_name)}${u.username?' (@'+esc(u.username)+')':''}</div>
        <div class="mo-sub">ID: ${u.user_id}</div>
      </div>
      <button class="mo-x" onclick="closeMo()">${_svg('x','13')}</button>
    </div>
    <div class="ir"><span class="il">–°—Ç–∞—Ç—É—Å</span><span class="iv"><span class="bd ${u.is_banned?'r':'g'}">${u.is_banned?'–ó–∞–±–∞–Ω–µ–Ω':'–ê–∫—Ç–∏–≤–µ–Ω'}</span></span></div>
    <div class="ir"><span class="il">–ü–æ–¥–ø–∏—Å–∫–∞</span><span class="iv">${subBadge(u)}</span></div>
    <div class="ir"><span class="il">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span><span class="iv">${fmtD(u.registered_at)}</span></div>
    <div class="ir"><span class="il">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</span><span class="iv">${fmtM(u.total_spent)}</span></div>
    <div class="mo-sect">–ü–æ–¥–ø–∏—Å–∫–∏</div>
    <table class="mini-t">
      <thead><tr><th>ID</th><th>PasarGuard</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ò—Å—Ç–µ–∫–∞–µ—Ç</th></tr></thead>
      <tbody>${subRows}</tbody>
    </table>
    <div class="mo-sect">–ü–ª–∞—Ç–µ–∂–∏</div>
    <table class="mini-t">
      <thead><tr><th>–°—Ç–∞—Ç—É—Å</th><th>–°—É–º–º–∞</th><th>–î–∞—Ç–∞</th></tr></thead>
      <tbody>${payRows}</tbody>
    </table>
    <div class="mo-act">
      ${!hasActive?`<button class="btn btn-grn" onclick="closeMo();confirmGrant(${u.user_id},'${esc(u.first_name)}')">${_svg('gift','13')} –í—ã–¥–∞—Ç—å</button>`:''}
      ${hasActive ?`<button class="btn btn-acc" onclick="closeMo();confirmExtend(${u.user_id},'${esc(u.first_name)}')">${_svg('plus','13')} –ü—Ä–æ–¥–ª–∏—Ç—å</button>`:''}
      ${hasActive ?`<button class="btn btn-d" style="border-color:rgba(99,102,241,.25)" onclick="closeMo();confirmAdjust(${u.user_id},'${esc(u.first_name)}','${u.expires_at||''}')">${_svg('cal','13')} –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ä–æ–∫</button>`:''}
      ${hasActive ?`<button class="btn btn-red" onclick="closeMo();confirmDisable(${u.user_id},'${esc(u.first_name)}')">${_svg('stop','13')} –û—Ç–∫–ª—é—á–∏—Ç—å</button>`:''}
      ${u.is_banned
        ?`<button class="btn btn-grn" onclick="doBan(${u.user_id},false)">${_svg('unban','13')} –†–∞–∑–±–∞–Ω–∏—Ç—å</button>`
        :`<button class="btn btn-d" onclick="doBan(${u.user_id},true)"
            style="border-color:rgba(239,68,68,.3);color:var(--red)">${_svg('ban','13')} –ó–∞–±–∞–Ω–∏—Ç—å</button>`}
      <button class="btn btn-red" onclick="closeMo();confirmDelete(${u.user_id},'${esc(u.first_name)}')">${_svg('trash','13')} –£–¥–∞–ª–∏—Ç—å</button>
    </div>`);
}

// ‚îÄ‚îÄ Subscription confirmations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function confirmGrant(uid, name) {
  openMo(`
    <div class="mo-handle"></div>
    <div class="confirm-ico ico-grn">${_svg('gift','38')}</div>
    <div class="mo-title" style="text-align:center;margin-bottom:8px">–í—ã–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</div>
    <div class="confirm-msg">–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ PasarGuard<br>–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –¥–ª—è <b>${esc(name)}</b></div>
    <div class="mo-btns">
      <button class="btn btn-d btn-lg" onclick="closeMo()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-grn btn-lg" id="cb" onclick="doGrant(${uid})">${_svg('gift','14')} –í—ã–¥–∞—Ç—å</button>
    </div>`);
}

function confirmExtend(uid, name) {
  openMo(`
    <div class="mo-handle"></div>
    <div class="confirm-ico ico-acc">${_svg('plus','38')}</div>
    <div class="mo-title" style="text-align:center;margin-bottom:8px">–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</div>
    <div class="confirm-msg">–ü–æ–¥–ø–∏—Å–∫–∞ –±—É–¥–µ—Ç –ø—Ä–æ–¥–ª–µ–Ω–∞ –≤ PasarGuard –∏ –ë–î<br>–¥–ª—è <b>${esc(name)}</b></div>
    <div class="mo-btns">
      <button class="btn btn-d btn-lg" onclick="closeMo()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-acc btn-lg" id="cb" onclick="doExtend(${uid})">${_svg('plus','14')} –ü—Ä–æ–¥–ª–∏—Ç—å</button>
    </div>`);
}

function confirmDisable(uid, name) {
  openMo(`
    <div class="mo-handle"></div>
    <div class="confirm-ico ico-red">${_svg('stop','38')}</div>
    <div class="mo-title" style="text-align:center;margin-bottom:8px">–û—Ç–∫–ª—é—á–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</div>
    <div class="confirm-msg">–ü–æ–¥–ø–∏—Å–∫–∞ <b>${esc(name)}</b> –±—É–¥–µ—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞</div>
    <label class="chk-row">
      <input type="checkbox" id="del-mz"> –£–¥–∞–ª–∏—Ç—å –∏–∑ PasarGuard
    </label>
    <div class="mo-btns">
      <button class="btn btn-d btn-lg" onclick="closeMo()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-red btn-lg" id="cb" onclick="doDisable(${uid})">${_svg('stop','14')} –û—Ç–∫–ª—é—á–∏—Ç—å</button>
    </div>`);
}

function confirmDelete(uid, name) {
  openMo(`
    <div class="mo-handle"></div>
    <div class="confirm-ico ico-red">${_svg('trash','38')}</div>
    <div class="mo-title" style="text-align:center;margin-bottom:8px">–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
    <div class="confirm-msg">
      –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å <b>${esc(name)}</b> (ID: ${uid}) –±—É–¥–µ—Ç –Ω–∞–≤—Å–µ–≥–¥–∞ —É–¥–∞–ª—ë–Ω<br>
      –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤–º–µ—Å—Ç–µ —Å–æ –≤—Å–µ–º–∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏.
    </div>
    <label class="chk-row">
      <input type="checkbox" id="del-mz-full"> –£–¥–∞–ª–∏—Ç—å –∏–∑ PasarGuard
    </label>
    <div class="mo-btns">
      <button class="btn btn-d btn-lg" onclick="closeMo()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-red btn-lg" id="cb" onclick="doDelete(${uid})">${_svg('trash','14')} –£–¥–∞–ª–∏—Ç—å</button>
    </div>`);
}

// ‚îÄ‚îÄ Adjust subscription (slider + exact date) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function confirmAdjust(uid, name, expiresAt) {
  const curTs  = expiresAt ? Math.floor(new Date(expiresAt).getTime() / 1000) : Math.floor(Date.now() / 1000);
  const curDt  = new Date(curTs * 1000);

  // Format for date input (YYYY-MM-DD)
  const pad    = n => String(n).padStart(2, '0');
  const ymd    = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const hm     = d => `${pad(d.getHours())}:${pad(d.getMinutes())}`;
  const curDateVal  = ymd(curDt);
  const curTimeVal  = hm(curDt);

  openMo(`
    <div class="mo-handle"></div>
    <div class="mo-head">
      <div>
        <div class="mo-title">${_svg('cal','16')} –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ä–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏</div>
        <div class="mo-sub">${esc(name)} ‚Äî —Å–µ–π—á–∞—Å: ${fmtD(expiresAt)}</div>
      </div>
      <button class="mo-x" onclick="closeMo()">${_svg('x','13')}</button>
    </div>

    <div class="adj-tabs">
      <button class="adj-tab on" id="tab-days" onclick="adjTab('days')">–ü–æ –¥–Ω—è–º</button>
      <button class="adj-tab"    id="tab-date" onclick="adjTab('date')">–¢–æ—á–Ω–∞—è –¥–∞—Ç–∞</button>
    </div>

    <!-- Pane: slider -->
    <div class="adj-pane on" id="pane-days">
      <div class="adj-days-display zer" id="adj-num">0</div>
      <div class="adj-days-suffix" id="adj-suffix">–¥–Ω–µ–π (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)</div>
      <div class="adj-slider-wrap">
        <input type="range" class="adj-slider" id="adj-slider"
          min="-365" max="365" value="0" step="1"
          oninput="adjSliderMove(this.value, ${curTs})">
        <div class="adj-slider-labels"><span>‚àí365</span><span>0</span><span>+365</span></div>
      </div>
      <div class="adj-preview" id="adj-preview-days">
        <div>
          <div class="adj-preview-label">–¢–µ–∫—É—â–∏–π —Å—Ä–æ–∫</div>
          <div class="adj-preview-val">${fmtDate(expiresAt)}</div>
        </div>
        <div class="adj-preview-arrow">${_svg('arrow','16')}</div>
        <div>
          <div class="adj-preview-label">–ù–æ–≤—ã–π —Å—Ä–æ–∫</div>
          <div class="adj-preview-val adj-new" id="adj-new-days">${fmtDate(expiresAt)}</div>
        </div>
      </div>
      <div id="adj-warn-days"></div>
    </div>

    <!-- Pane: exact date -->
    <div class="adj-pane" id="pane-date">
      <div style="margin-bottom:8px;font-size:12px;color:var(--txt2)">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è:</div>
      <div style="display:flex;gap:8px;margin-bottom:4px">
        <input type="date" class="adj-date-field" id="adj-date-inp"
          value="${curDateVal}" oninput="adjDateMove(${curTs})">
        <input type="time" class="adj-date-field" id="adj-time-inp"
          value="${curTimeVal}" style="width:120px;flex-shrink:0" oninput="adjDateMove(${curTs})">
      </div>
      <div class="adj-preview" id="adj-preview-date">
        <div>
          <div class="adj-preview-label">–¢–µ–∫—É—â–∏–π —Å—Ä–æ–∫</div>
          <div class="adj-preview-val">${fmtDate(expiresAt)}</div>
        </div>
        <div class="adj-preview-arrow">${_svg('arrow','16')}</div>
        <div>
          <div class="adj-preview-label">–ù–æ–≤—ã–π —Å—Ä–æ–∫</div>
          <div class="adj-preview-val adj-new" id="adj-new-date">${fmtDate(expiresAt)}</div>
        </div>
      </div>
      <div id="adj-warn-date"></div>
      <div class="adj-date-note">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –¥–ª—è —Ç–µ—Å—Ç–∞ –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—Ä–µ–º—è —á–µ—Ä–µ–∑ 1‚Äì2 —á–∞—Å–∞ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ.</div>
    </div>

    <div class="mo-btns" style="margin-top:20px">
      <button class="btn btn-d btn-lg" onclick="closeMo()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary btn-lg" id="cb" onclick="doAdjust(${uid}, ${curTs})">${_svg('cal','14')} –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>`);

  // Init slider gradient
  adjSliderMove(0, curTs);
}

function adjTab(tab) {
  ['days','date'].forEach(t => {
    $('tab-'+t).classList.toggle('on', t === tab);
    $('pane-'+t).classList.toggle('on', t === tab);
  });
}

function adjSliderMove(val, curTs) {
  val = parseInt(val);
  const sl  = $('adj-slider');
  const pct = ((val + 365) / 730 * 100).toFixed(1);
  if (sl) {
    sl.style.setProperty('--pct', pct + '%');
    sl.value = val;
  }
  const numEl = $('adj-num');
  const sfxEl = $('adj-suffix');
  const newEl = $('adj-new-days');
  const warnEl = $('adj-warn-days');
  if (!numEl) return;

  numEl.textContent = (val > 0 ? '+' : '') + val;
  numEl.className   = 'adj-days-display ' + (val < 0 ? 'neg' : val > 0 ? 'pos' : 'zer');

  const abs = Math.abs(val);
  const sfx = abs === 0 ? '–¥–Ω–µ–π (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)'
    : abs === 1 ? (val > 0 ? '–¥–µ–Ω—å' : '–¥–µ–Ω—å')
    : abs < 5  ? (val > 0 ? '–¥–Ω—è' : '–¥–Ω—è')
    : '–¥–Ω–µ–π';
  sfxEl.textContent = sfx;

  const newTs = curTs + val * 86400;
  const newDt = new Date(newTs * 1000);
  if (newEl) newEl.textContent = newDt.toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit', year:'numeric'});

  if (warnEl) {
    if (val < 0 && newTs < Date.now()/1000) {
      warnEl.innerHTML = `<div class="adj-warn">${_svg('warn','14')} –ü–æ–¥–ø–∏—Å–∫–∞ –æ–∫–∞–∂–µ—Ç—Å—è –≤ –ø—Ä–æ—à–ª–æ–º ‚Äî –±—É–¥–µ—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞</div>`;
    } else if (val < 0) {
      warnEl.innerHTML = `<div class="adj-warn">${_svg('warn','14')} –°—Ä–æ–∫ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è ‚Äî —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ</div>`;
    } else {
      warnEl.innerHTML = '';
    }
  }
}

function adjDateMove(curTs) {
  const dateEl = $('adj-date-inp');
  const timeEl = $('adj-time-inp');
  const newEl  = $('adj-new-date');
  const warnEl = $('adj-warn-date');
  if (!dateEl || !newEl) return;
  const dtStr = dateEl.value + 'T' + (timeEl?.value || '00:00');
  const newDt = new Date(dtStr);
  if (isNaN(newDt)) return;
  newEl.textContent = newDt.toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'});
  if (warnEl) {
    if (newDt.getTime() < Date.now()) {
      warnEl.innerHTML = `<div class="adj-warn">${_svg('warn','14')} –í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ —É–∂–µ –≤ –ø—Ä–æ—à–ª–æ–º ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è</div>`;
    } else {
      warnEl.innerHTML = '';
    }
  }
}

// ‚îÄ‚îÄ Action handlers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function doGrant(uid) {
  btnLoad('cb');
  const d = await api('/users/'+uid+'/sub/grant', {method:'POST', body:{}});
  closeMo();
  d.error ? toast(d.error, 'err') : (toast('–ü–æ–¥–ø–∏—Å–∫–∞ –≤—ã–¥–∞–Ω–∞!'), renderUsers());
}
async function doExtend(uid) {
  btnLoad('cb');
  const d = await api('/users/'+uid+'/sub/extend', {method:'POST', body:{}});
  closeMo();
  d.error ? toast(d.error, 'err') : (toast('–ü—Ä–æ–¥–ª–µ–Ω–∞!'), renderUsers());
}
async function doDisable(uid) {
  const del = $('del-mz')?.checked || false;
  btnLoad('cb');
  const d = await api('/users/'+uid+'/sub/disable', {method:'POST', body:{delete_panel:del}});
  closeMo();
  d.error ? toast(d.error, 'err') : (toast('–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞'), renderUsers());
}
async function doAdjust(uid, curTs) {
  // Determine active tab
  const isDateTab = $('tab-date')?.classList.contains('on');
  let body = {};
  if (isDateTab) {
    const dateEl = $('adj-date-inp');
    const timeEl = $('adj-time-inp');
    if (!dateEl?.value) { toast('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É', 'err'); return; }
    const dtStr = dateEl.value + 'T' + (timeEl?.value || '00:00');
    const ts    = Math.floor(new Date(dtStr).getTime() / 1000);
    if (isNaN(ts)) { toast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞', 'err'); return; }
    body = { exact_ts: ts };
  } else {
    const sl  = $('adj-slider');
    const val = sl ? parseInt(sl.value) : 0;
    body = { days: val, exact_ts: curTs + val * 86400 };
  }
  btnLoad('cb');
  const d = await api('/users/'+uid+'/sub/adjust', {method:'POST', body});
  closeMo();
  if (d.error) {
    toast(d.error, 'err');
  } else {
    const newDt = new Date(d.new_expires_ts * 1000).toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit', year:'numeric'});
    toast('–°—Ä–æ–∫ –æ–±–Ω–æ–≤–ª—ë–Ω ‚Üí ' + newDt);
    renderUsers();
  }
}


async function doBan(uid, banned) {
  const d = await api('/users/'+uid+'/ban', {method:'POST', body:{banned}});
  if (d.ok) { toast(banned?'–ó–∞–±–∞–Ω–µ–Ω':'–†–∞–∑–±–∞–Ω–µ–Ω', banned?'err':'ok'); closeMo(); renderUsers(); }
}
async function doDelete(uid) {
  const del = $('del-mz-full')?.checked || false;
  btnLoad('cb');
  const d = await api('/users/'+uid, {method:'DELETE', body:{delete_panel:del}});
  closeMo();
  d.error ? toast(d.error, 'err') : (toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω'), renderUsers());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAYMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const pF = {page:1, status:''};

async function renderPayments() {
  loading();
  const d  = await api('/payments?' + new URLSearchParams({page:pF.page, per_page:25, status:pF.status}));
  const tp = Math.ceil(d.total / 25);

  const rows = d.payments.map(p => `<tr>
    <td>
      <div style="font-weight:500">${esc(p.first_name||'‚Äî')}</div>
      <div style="color:var(--txt3);font-size:11px">${p.username?'@'+esc(p.username)+' ':''}<code style="font-size:10px">${p.user_id}</code></div>
    </td>
    <td><span class="bd ${p.status==='succeeded'?'g':p.status==='pending'?'y':'r'}">${p.status}</span></td>
    <td style="font-weight:600;white-space:nowrap">${fmtM(p.amount)}</td>
    <td style="font-size:10.5px;color:var(--txt3);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
      ${esc(p.yukassa_payment_id||'‚Äî')}
    </td>
    <td style="font-size:11.5px;white-space:nowrap;color:var(--txt2)">${fmtD(p.created_at)}</td>
  </tr>`).join('');

  setView(`
    <div class="tc">
      <div class="tb">
        <div class="tb-top">
          <h2>–ü–ª–∞—Ç–µ–∂–∏ <span class="tb-count">${d.total}</span></h2>
          <div class="tb-row">
            <select class="fsel" onchange="pF.status=this.value;pF.page=1;renderPayments()">
              <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
              <option value="succeeded" ${pF.status==='succeeded'?'selected':''}>–£—Å–ø–µ—à–Ω—ã–µ</option>
              <option value="pending"   ${pF.status==='pending'  ?'selected':''}>–û–∂–∏–¥–∞—é—â–∏–µ</option>
              <option value="canceled"  ${pF.status==='canceled' ?'selected':''}>–û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ</option>
            </select>
            <button class="btn btn-d btn-icon" title="–û–±–Ω–æ–≤–∏—Ç—å" onclick="renderPayments()">${_svg('refresh','13')}</button>
          </div>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–°—É–º–º–∞</th><th>–ÆKassa ID</th><th>–î–∞—Ç–∞</th>
          </tr></thead>
          <tbody>${rows || '<tr class="empty-row"><td colspan="5">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</td></tr>'}</tbody>
        </table>
      </div>
      ${mkPager(pF.page, tp, 'pF.page', 'renderPayments')}
    </div>`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BROADCAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const AUDIENCES = [
  {key:'all',        name:'–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',  desc:'–í—Å–µ –Ω–µ–∑–∞–±–∞–Ω–µ–Ω–Ω—ã–µ'},
  {key:'active',     name:'–ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞', desc:'–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å'},
  {key:'expiring',   name:'–ò—Å—Ç–µ–∫–∞–µ—Ç —Å–∫–æ—Ä–æ',    desc:'–ò—Å—Ç–µ–∫–∞–µ—Ç –≤ –±–ª–∏–∂. 3 –¥–Ω—è'},
  {key:'expired',    name:'–ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞',  desc:'–ë—ã–ª–∞ –ø–æ–¥–ø–∏—Å–∫–∞, —Å–µ–π—á–∞—Å –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞'},
  {key:'no_sub',     name:'–ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏',      desc:'–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–∫—É–ø–∞–ª–∏'},
  {key:'no_payment', name:'–ë–µ–∑ –ø–ª–∞—Ç–µ–∂–µ–π',      desc:'–ó–∞—Ä–µ–≥., –Ω–æ –Ω–∏ —Ä–∞–∑—É –Ω–µ –ø–ª–∞—Ç–∏–ª–∏'},
  {key:'paid_once',  name:'–¢–æ–ª—å–∫–æ 1 –ø–ª–∞—Ç—ë–∂',   desc:'–ö—É–ø–∏–ª–∏ –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî –Ω–µ –≤–µ—Ä–Ω—É–ª–∏—Å—å'},
];
let bAud    = 'all';
let bCounts = {};

async function renderBroadcast() {
  loading();
  const counts = await Promise.all(AUDIENCES.map(a => api('/broadcast/count?audience=' + a.key)));
  AUDIENCES.forEach((a, i) => { bCounts[a.key] = counts[i]?.count ?? '?'; });
  _renderBroadcastUI();
}

function _renderBroadcastUI() {
  const cards = AUDIENCES.map(a => `
    <div class="aud-card ${bAud===a.key?'sel':''}" onclick="bAud='${a.key}';_renderBroadcastUI()">
      <div class="aud-name">${a.name}</div>
      <div class="aud-desc">${a.desc}</div>
      <div class="aud-count">${bCounts[a.key] ?? '‚Ä¶'} —á–µ–ª.</div>
    </div>`).join('');

  setView(`
    <div class="tc bpage" style="padding:22px">
      <h2>–†–∞—Å—Å—ã–ª–∫–∞</h2>
      <p class="hint">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è HTML: &lt;b&gt;, &lt;i&gt;, &lt;code&gt;, &lt;a href&gt;</p>
      <textarea class="bcast-ta" id="bt" placeholder="–¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏..."></textarea>
      <div class="aud-label">–ê—É–¥–∏—Ç–æ—Ä–∏—è</div>
      <div class="aud-grid">${cards}</div>
      <div class="bcast-footer">
        <button class="btn btn-primary btn-lg" id="sbtn" onclick="sendBroadcast()">
          üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å
        </button>
        <span class="bcast-total">–ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π: <b>${bCounts[bAud] ?? '‚Ä¶'}</b></span>
      </div>
      <div id="bres" style="display:none"></div>
    </div>`);
}

async function sendBroadcast() {
  const text = $('bt')?.value?.trim();
  if (!text) { toast('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç', 'err'); return; }
  const btn = $('sbtn');
  btn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...'; btn.disabled = true;
  const d = await api('/broadcast', {method:'POST', body:{text, audience:bAud}});
  btn.textContent = 'üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å'; btn.disabled = false;
  if (d.error) { toast(d.error, 'err'); return; }
  const el = $('bres');
  el.style.display = 'block';
  el.className = 'bcast-ok';
  el.innerHTML = `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: <b>${d.sent}</b>, –æ—à–∏–±–æ–∫: <b>${d.failed}</b>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PAGINATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function mkPager(page, total, varName, fn) {
  if (total <= 1) return '';
  const btns = [];
  const s = Math.max(1, page - 2), e = Math.min(total, page + 2);
  if (s > 1)
    btns.push(`<button class="pb" onclick="${varName}=1;${fn}()">1</button>${s>2?'<span class="ptxt">‚Ä¶</span>':''}`);
  for (let i = s; i <= e; i++)
    btns.push(`<button class="pb ${i===page?'on':''}" onclick="${varName}=${i};${fn}()">${i}</button>`);
  if (e < total)
    btns.push(`${e<total-1?'<span class="ptxt">‚Ä¶</span>':''}<button class="pb" onclick="${varName}=${total};${fn}()">${total}</button>`);
  return `<div class="pg">
    <button class="pb" onclick="${varName}=Math.max(1,${page}-1);${fn}()" ${page<=1?'disabled':''}>‚Üê</button>
    ${btns.join('')}
    <button class="pb" onclick="${varName}=Math.min(${total},${page}+1);${fn}()" ${page>=total?'disabled':''}>‚Üí</button>
  </div>`;
}

// ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
checkAuth();
</script>
</body>
</html>
