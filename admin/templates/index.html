<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VPN Admin</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
/* â”€â”€ Tokens â”€â”€ */
:root{
  --bg:#0d0f18;--s1:#141824;--s2:#1c2133;--b:#252b42;
  --acc:#7c6ef5;--grn:#34d399;--ylw:#fbbf24;--red:#f87171;
  --txt:#e2e8f0;--dim:#64748b;--r:10px;
  --sidebar:215px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--txt);font:14px/1.5 'Inter','Segoe UI',system-ui,sans-serif}

/* â”€â”€ Login â”€â”€ */
#login{display:flex;align-items:center;justify-content:center;height:100vh;
  background:radial-gradient(ellipse 80% 60% at 50% -10%,#1e1b4b,var(--bg))}
.lcard{background:var(--s1);border:1px solid var(--b);border-radius:18px;
  padding:40px 32px;width:min(360px,92vw);text-align:center;box-shadow:0 32px 64px rgba(0,0,0,.5)}
.lcard h1{font-size:22px;font-weight:700;margin:12px 0 6px}
.lcard p{color:var(--dim);font-size:13px;margin-bottom:28px}
.linput{width:100%;padding:12px 14px;background:var(--s2);border:1px solid var(--b);
  border-radius:8px;color:var(--txt);font-size:15px;outline:none;margin-bottom:12px;transition:.2s}
.linput:focus{border-color:var(--acc)}
.lbtn{width:100%;padding:13px;background:var(--acc);color:#fff;border:none;border-radius:8px;
  font-size:15px;font-weight:600;cursor:pointer;transition:.2s}
.lbtn:hover{opacity:.85}
.lerr{color:var(--red);font-size:12px;margin-top:10px;min-height:18px}

/* â”€â”€ App shell â”€â”€ */
#app{display:none;height:100vh;overflow:hidden}
.shell{display:flex;height:100vh;overflow:hidden}

/* â”€â”€ Sidebar â”€â”€ */
.side{
  width:var(--sidebar);flex-shrink:0;background:var(--s1);border-right:1px solid var(--b);
  display:flex;flex-direction:column;transition:transform .25s;z-index:50;
}
.brand{padding:18px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--b)}
.brand-icon{font-size:24px;flex-shrink:0}
.brand-name{font-size:15px;font-weight:700;white-space:nowrap}
.brand-sub{font-size:10px;color:var(--dim);letter-spacing:.05em}
nav{flex:1;padding:8px;overflow-y:auto}
.nav-sec{font-size:10px;color:var(--dim);text-transform:uppercase;
  letter-spacing:.1em;padding:12px 8px 4px;white-space:nowrap}
.ni{display:flex;align-items:center;gap:8px;padding:10px 10px;border-radius:7px;cursor:pointer;
  color:var(--dim);font-size:13px;font-weight:500;transition:.15s;margin-bottom:1px;white-space:nowrap}
.ni:hover{background:var(--s2);color:var(--txt)}
.ni.on{background:rgba(124,110,245,.14);color:var(--acc)}
.ni .ic{width:20px;text-align:center;font-size:15px;flex-shrink:0}
.side-foot{padding:12px;border-top:1px solid var(--b);flex-shrink:0}
.out-btn{width:100%;padding:9px;background:0;border:1px solid var(--b);border-radius:7px;
  color:var(--dim);cursor:pointer;font-size:12px;transition:.15s}
.out-btn:hover{border-color:var(--red);color:var(--red)}

/* â”€â”€ Mobile sidebar overlay â”€â”€ */
.side-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:40}

/* â”€â”€ Main area â”€â”€ */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.topbar{
  padding:12px 16px;background:var(--s1);border-bottom:1px solid var(--b);
  display:flex;align-items:center;gap:12px;flex-shrink:0;
}
.menu-btn{display:none;background:none;border:none;color:var(--txt);
  font-size:20px;cursor:pointer;padding:2px 6px;line-height:1;flex-shrink:0}
.topbar h1{font-size:16px;font-weight:700;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.online{background:rgba(52,211,153,.12);color:var(--grn);border-radius:20px;
  padding:3px 10px;font-size:11px;font-weight:600;flex-shrink:0;white-space:nowrap}
.view{flex:1;overflow-y:auto;padding:16px;-webkit-overflow-scrolling:touch}

/* â”€â”€ Stats grid â”€â”€ */
.sg{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-bottom:16px}
.sc{background:var(--s1);border:1px solid var(--b);border-radius:var(--r);padding:16px;position:relative;overflow:hidden}
.sc::after{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.sc.p::after{background:var(--acc)}.sc.g::after{background:var(--grn)}
.sc.y::after{background:var(--ylw)}.sc.r::after{background:var(--red)}
.sl{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
.sv{font-size:24px;font-weight:700;margin-bottom:2px}
.ss{font-size:11px;color:var(--dim)}

/* â”€â”€ Charts â”€â”€ */
.cg{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.cc{background:var(--s1);border:1px solid var(--b);border-radius:var(--r);padding:16px}
.ct{font-size:12px;font-weight:600;color:var(--dim);margin-bottom:12px}

/* â”€â”€ Card â”€â”€ */
.tc{background:var(--s1);border:1px solid var(--b);border-radius:var(--r);overflow:hidden}

/* â”€â”€ Toolbar â”€â”€ */
.tb{padding:12px 14px;border-bottom:1px solid var(--b);display:flex;flex-direction:column;gap:10px}
.tb-top{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.tb-top h2{font-size:14px;font-weight:600;white-space:nowrap}
.tb-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

/* â”€â”€ Filter panel â”€â”€ */
.fp{background:var(--s2);border-radius:8px;padding:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.fg{display:flex;flex-direction:column;gap:4px;min-width:0}
.fg label{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.05em;white-space:nowrap}
.date-range{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.date-range span{font-size:11px;color:var(--dim)}

/* â”€â”€ Form controls â”€â”€ */
.si{background:var(--s2);border:1px solid var(--b);border-radius:7px;
  padding:8px 11px;color:var(--txt);font-size:13px;outline:none;transition:.2s;
  -webkit-appearance:none}
.si:focus{border-color:var(--acc)}
.di{background:var(--s2);border:1px solid var(--b);border-radius:7px;
  padding:7px 10px;color:var(--txt);font-size:12px;outline:none;cursor:pointer;
  transition:.2s;-webkit-appearance:none}
.di:focus{border-color:var(--acc)}
.di::-webkit-calendar-picker-indicator{filter:invert(.5);cursor:pointer}
.fsel{background:var(--s2);border:1px solid var(--b);border-radius:7px;
  padding:8px 10px;color:var(--txt);font-size:13px;outline:none;cursor:pointer;
  -webkit-appearance:none}
.fsel:focus{border-color:var(--acc)}

/* â”€â”€ Buttons â”€â”€ */
.btn{padding:7px 13px;border-radius:7px;border:none;cursor:pointer;font-size:13px;
  font-weight:600;transition:.15s;display:inline-flex;align-items:center;
  gap:5px;white-space:nowrap;-webkit-tap-highlight-color:transparent}
.btn:disabled{opacity:.45;cursor:not-allowed}
.btn-acc{background:rgba(124,110,245,.2);color:var(--acc);border:1px solid rgba(124,110,245,.3)}
.btn-acc:hover:not(:disabled){background:rgba(124,110,245,.32)}
.btn-grn{background:rgba(52,211,153,.15);color:var(--grn);border:1px solid rgba(52,211,153,.3)}
.btn-grn:hover:not(:disabled){background:rgba(52,211,153,.28)}
.btn-red{background:rgba(248,113,113,.13);color:var(--red);border:1px solid rgba(248,113,113,.3)}
.btn-red:hover:not(:disabled){background:rgba(248,113,113,.25)}
.btn-d{background:0;color:var(--dim);border:1px solid var(--b)}
.btn-d:hover:not(:disabled){color:var(--txt);border-color:var(--txt)}
.btn-lg{padding:11px 22px;font-size:14px;border-radius:8px}
.btn-full{width:100%;justify-content:center}
.btn-icon{padding:7px 10px}
.btn-sm{padding:5px 10px;font-size:12px;border-radius:6px}

/* â”€â”€ Search bar â”€â”€ */
.search-wrap{display:flex;gap:6px;flex:1;min-width:0}
.search-wrap .si{flex:1;min-width:0}

/* â”€â”€ Filter toggle â”€â”€ */
.ftgl{display:flex;align-items:center;gap:5px;padding:7px 12px;border-radius:7px;
  border:1px solid var(--b);background:0;color:var(--dim);cursor:pointer;
  font-size:13px;font-weight:500;transition:.15s;white-space:nowrap;flex-shrink:0}
.ftgl:hover,.ftgl.on{border-color:var(--acc);color:var(--acc);background:rgba(124,110,245,.1)}
.f-count{background:var(--acc);color:#fff;border-radius:10px;
  padding:1px 6px;font-size:10px;margin-left:2px}

/* â”€â”€ Active filter chips â”€â”€ */
.af-chips{display:flex;gap:6px;flex-wrap:wrap}
.afc{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;
  background:rgba(124,110,245,.1);border:1px solid rgba(124,110,245,.25);
  border-radius:20px;font-size:11px;color:var(--acc);white-space:nowrap}
.afc button{background:none;border:none;color:var(--acc);cursor:pointer;
  font-size:13px;padding:0;line-height:1;opacity:.7;margin-left:2px}
.afc button:hover{opacity:1}

/* â”€â”€ Table â”€â”€ */
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;min-width:480px}
thead th{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:.05em;
  padding:10px 12px;text-align:left;border-bottom:1px solid var(--b);white-space:nowrap}
td{padding:10px 12px;font-size:12px;border-bottom:1px solid rgba(37,43,66,.6);vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(255,255,255,.015)}
.empty-row td{text-align:center;color:var(--dim);padding:36px;font-size:13px}

/* â”€â”€ Badges â”€â”€ */
.bd{display:inline-flex;align-items:center;border-radius:20px;padding:2px 9px;
  font-size:10px;font-weight:600;white-space:nowrap}
.bd.g{background:rgba(52,211,153,.13);color:var(--grn)}
.bd.r{background:rgba(248,113,113,.13);color:var(--red)}
.bd.y{background:rgba(251,191,36,.13);color:var(--ylw)}
.bd.p{background:rgba(124,110,245,.13);color:var(--acc)}
.bd.d{background:rgba(100,116,139,.13);color:var(--dim)}

/* â”€â”€ Sub column â”€â”€ */
.acts{display:flex;gap:4px;flex-wrap:nowrap}
.sub-col{display:flex;flex-direction:column;gap:2px}
.sub-days{font-size:10px;color:var(--dim)}

/* â”€â”€ Pagination â”€â”€ */
.pg{display:flex;align-items:center;justify-content:center;gap:6px;padding:14px;flex-wrap:wrap}
.pb{padding:6px 12px;background:var(--s2);border:1px solid var(--b);border-radius:6px;
  color:var(--txt);cursor:pointer;font-size:12px;transition:.15s;
  -webkit-tap-highlight-color:transparent}
.pb:hover{border-color:var(--acc);color:var(--acc)}
.pb.on{background:var(--acc);border-color:var(--acc);color:#fff}
.pb:disabled{opacity:.35;cursor:not-allowed}
.ptxt{font-size:12px;color:var(--dim);padding:0 2px}

/* â”€â”€ Modal â”€â”€ */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;
  display:flex;align-items:flex-end;justify-content:center;
  backdrop-filter:blur(3px);padding:0}
.mo{background:var(--s1);border:1px solid var(--b);border-radius:16px 16px 0 0;
  padding:20px 20px 28px;width:100%;max-width:600px;max-height:90vh;
  overflow-y:auto;box-shadow:0 -8px 40px rgba(0,0,0,.5)}
.mo-handle{width:40px;height:4px;background:var(--b);border-radius:4px;
  margin:0 auto 16px;flex-shrink:0}
.mo-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px}
.mo-title{font-size:16px;font-weight:700}
.mo-sub{font-size:12px;color:var(--dim);margin-top:2px}
.mo-x{background:none;border:none;color:var(--dim);cursor:pointer;
  font-size:20px;padding:0;line-height:1;flex-shrink:0}
.mo-x:hover{color:var(--txt)}
.ir{display:flex;justify-content:space-between;align-items:center;
  padding:10px 0;border-bottom:1px solid rgba(37,43,66,.8);font-size:13px;gap:12px}
.ir:last-child{border-bottom:none}
.il{color:var(--dim);flex-shrink:0}
.iv{font-weight:500;max-width:260px;word-break:break-all;text-align:right;font-size:12px}
.mo-act{display:flex;gap:8px;margin-top:20px;flex-wrap:wrap}
.mo-sect{font-size:11px;font-weight:600;color:var(--dim);margin:16px 0 8px;
  text-transform:uppercase;letter-spacing:.05em}
.mini-t{width:100%;border-collapse:collapse;border:1px solid var(--b);
  border-radius:8px;overflow:hidden;font-size:11px}
.mini-t th{font-size:10px;color:var(--dim);text-transform:uppercase;
  padding:8px 10px;background:var(--s2);text-align:left;letter-spacing:.04em}
.mini-t td{padding:8px 10px;border-top:1px solid var(--b)}

/* â”€â”€ Confirm modal â”€â”€ */
.confirm-icon{font-size:40px;text-align:center;margin-bottom:12px}
.confirm-msg{text-align:center;color:var(--dim);font-size:13px;
  margin-bottom:20px;line-height:1.7}
.mo-btns{display:flex;gap:10px;justify-content:center}

/* â”€â”€ Broadcast page â”€â”€ */
.bpage{max-width:640px}
.bpage h2{font-size:16px;font-weight:700;margin-bottom:4px}
.bpage .hint{color:var(--dim);font-size:13px;margin-bottom:18px}
.bcast-ta{width:100%;min-height:140px;background:var(--s2);border:1px solid var(--b);
  border-radius:8px;padding:12px;color:var(--txt);font-size:14px;outline:none;
  resize:vertical;transition:.2s;margin-bottom:14px;line-height:1.5}
.bcast-ta:focus{border-color:var(--acc)}
.aud-label{font-size:11px;color:var(--dim);text-transform:uppercase;
  letter-spacing:.06em;margin-bottom:8px}
.aud-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;margin-bottom:16px}
.aud-card{
  padding:12px 14px;background:var(--s2);border:2px solid var(--b);
  border-radius:9px;cursor:pointer;transition:.15s;
  -webkit-tap-highlight-color:transparent;
}
.aud-card:hover{border-color:var(--acc);background:rgba(124,110,245,.06)}
.aud-card.sel{border-color:var(--acc);background:rgba(124,110,245,.12)}
.aud-name{font-size:13px;font-weight:600;margin-bottom:2px}
.aud-desc{font-size:11px;color:var(--dim);line-height:1.4}
.aud-count{font-size:13px;font-weight:700;color:var(--acc);margin-top:4px}
.bcast-footer{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
.bcast-total{font-size:13px;color:var(--dim)}
.bcast-total b{color:var(--txt)}
.bcast-ok{margin-top:14px;padding:12px 16px;background:rgba(52,211,153,.08);
  border:1px solid rgba(52,211,153,.25);border-radius:8px;color:var(--grn);font-size:14px}

/* â”€â”€ Loading â”€â”€ */
.ld{display:flex;align-items:center;justify-content:center;padding:48px;color:var(--dim);gap:10px}
.sp{width:18px;height:18px;border:2px solid var(--b);border-top-color:var(--acc);
  border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ Toast â”€â”€ */
#toast{position:fixed;bottom:20px;right:16px;background:var(--s2);border:1px solid var(--b);
  border-radius:9px;padding:12px 18px;font-size:13px;z-index:999;
  transform:translateY(80px);opacity:0;transition:.28s;pointer-events:none;
  max-width:calc(100vw - 32px)}
#toast.show{transform:translateY(0);opacity:1}
#toast.ok{border-color:rgba(52,211,153,.5);color:var(--grn)}
#toast.err{border-color:rgba(248,113,113,.5);color:var(--red)}

/* â”€â”€ Mobile â”€â”€ */
@media(max-width:680px){
  .side{
    position:fixed;top:0;left:0;bottom:0;
    transform:translateX(-100%);
  }
  .side.open{transform:translateX(0)}
  .side-overlay{display:block}
  .menu-btn{display:block}
  .cg{grid-template-columns:1fr}
  .sg{grid-template-columns:repeat(2,1fr)}
  .tb-top{flex-direction:column;align-items:flex-start}
  .search-wrap .si{font-size:16px}/* prevent zoom iOS */
  .view{padding:12px}
  table{min-width:400px}
  .aud-grid{grid-template-columns:1fr 1fr}
}
@media(max-width:400px){
  .sg{grid-template-columns:1fr 1fr}
  .aud-grid{grid-template-columns:1fr}
}

/* â”€â”€ Desktop: modal centered â”€â”€ */
@media(min-width:681px){
  .ov{align-items:center;padding:20px}
  .mo{border-radius:16px;max-height:85vh}
  .mo-handle{display:none}
}
</style>
</head>
<body>

<!-- Login -->
<div id="login">
  <div class="lcard">
    <div style="font-size:44px">ğŸ›¡ï¸</div>
    <h1>VPN Admin</h1>
    <p>Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°</p>
    <input class="linput" type="password" id="pw" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ"
      onkeydown="if(event.key==='Enter')doLogin()">
    <button class="lbtn" onclick="doLogin()">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</button>
    <div class="lerr" id="lerr"></div>
  </div>
</div>

<!-- App -->
<div id="app">
<div class="shell">

  <!-- Sidebar overlay (mobile) -->
  <div class="side-overlay" id="sov" onclick="closeSidebar()" style="display:none"></div>

  <!-- Sidebar -->
  <aside class="side" id="sidebar">
    <div class="brand">
      <div class="brand-icon">ğŸ›¡ï¸</div>
      <div><div class="brand-name">VPN Admin</div><div class="brand-sub">PANEL</div></div>
    </div>
    <nav>
      <div class="nav-sec">Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ</div>
      <div class="ni on" data-p="dash"      onclick="go('dash')"><span class="ic">ğŸ“Š</span>Ğ”Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´</div>
      <div class="nav-sec">Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…</div>
      <div class="ni"    data-p="users"     onclick="go('users')"><span class="ic">ğŸ‘¥</span>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸</div>
      <div class="ni"    data-p="payments"  onclick="go('payments')"><span class="ic">ğŸ’°</span>ĞŸĞ»Ğ°Ñ‚ĞµĞ¶Ğ¸</div>
      <div class="nav-sec">Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹</div>
      <div class="ni"    data-p="broadcast" onclick="go('broadcast')"><span class="ic">ğŸ“¢</span>Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ°</div>
    </nav>
    <div class="side-foot">
      <button class="out-btn" onclick="doLogout()">ğŸšª Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button>
    </div>
  </aside>

  <!-- Main -->
  <div class="main">
    <div class="topbar">
      <button class="menu-btn" onclick="openSidebar()">â˜°</button>
      <h1 id="ptitle">Ğ”Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´</h1>
      <span class="online">â— ĞĞ½Ğ»Ğ°Ğ¹Ğ½</span>
    </div>
    <div class="view" id="view">
      <div class="ld"><div class="sp"></div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
    </div>
  </div>
</div>
</div>

<!-- Modal -->
<div class="ov" id="modal" style="display:none" onclick="if(event.target===this)closeMo()">
  <div class="mo" id="mo-body"></div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const $ = id => document.getElementById(id);
let _charts = {};

async function api(path, opts = {}) {
  const r = await fetch('/api' + path, {
    headers: {'Content-Type':'application/json'},
    ...opts,
    body: opts.body !== undefined ? JSON.stringify(opts.body) : undefined,
  });
  return r.json();
}

function toast(msg, type = 'ok') {
  const el = $('toast');
  el.textContent = msg;
  el.className = `show ${type}`;
  clearTimeout(window._tt);
  window._tt = setTimeout(() => el.className = '', 3200);
}

function openMo(html)  { $('mo-body').innerHTML = html; $('modal').style.display = 'flex'; }
function closeMo()     { $('modal').style.display = 'none'; }

function openSidebar() {
  $('sidebar').classList.add('open');
  $('sov').style.display = 'block';
  document.body.style.overflow = 'hidden';
}
function closeSidebar() {
  $('sidebar').classList.remove('open');
  $('sov').style.display = 'none';
  document.body.style.overflow = '';
}

function esc(s) {
  return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function fmtM(v) {
  return (+(v||0)).toLocaleString('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0});
}
function fmtD(s) {
  if (!s) return 'â€”';
  return new Date(s).toLocaleString('ru-RU',
    {day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'});
}
function fmtDate(s) {
  if (!s) return 'â€”';
  return new Date(s).toLocaleDateString('ru-RU',
    {day:'2-digit',month:'2-digit',year:'numeric'});
}
function today() { return new Date().toISOString().slice(0,10); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function checkAuth() {
  const d = await api('/me');
  d.logged_in ? showApp() : ($('login').style.display = 'flex');
}
async function doLogin() {
  const d = await api('/login', {method:'POST', body:{password: $('pw').value}});
  d.ok ? showApp() : ($('lerr').textContent = d.error || 'ĞÑˆĞ¸Ğ±ĞºĞ°');
}
async function doLogout() {
  await api('/logout', {method:'POST'});
  $('app').style.display = 'none';
  $('login').style.display = 'flex';
  $('pw').value = '';
}
function showApp() {
  $('login').style.display = 'none';
  $('app').style.display = 'block';
  go('dash');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TITLES = {dash:'Ğ”Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´', users:'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸', payments:'ĞŸĞ»Ğ°Ñ‚ĞµĞ¶Ğ¸', broadcast:'Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ°'};
const PAGES  = {dash:renderDash, users:renderUsers, payments:renderPayments, broadcast:renderBroadcast};

function go(page) {
  closeSidebar();
  document.querySelectorAll('.ni').forEach(el => el.classList.toggle('on', el.dataset.p === page));
  $('ptitle').textContent = TITLES[page] || page;
  (PAGES[page] || (() => {}))();
}
function setView(html) { $('view').innerHTML = html; }
function loading()     { setView('<div class="ld"><div class="sp"></div>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function renderDash() {
  loading();
  const d = await api('/stats');
  setView(`
    <div class="sg">
      <div class="sc p"><div class="sl">ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</div><div class="sv">${d.total_users}</div><div class="ss">+${d.new_today} ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ</div></div>
      <div class="sc g"><div class="sl">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¾Ğº</div><div class="sv">${d.active_subs}</div><div class="ss">${d.expiring} Ğ¸ÑÑ‚ĞµĞºĞ°ÑÑ‚</div></div>
      <div class="sc y"><div class="sl">Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ° Ğ·Ğ° Ğ¼ĞµÑÑÑ†</div><div class="sv">${fmtM(d.revenue_month)}</div><div class="ss">Ğ’ÑĞµĞ³Ğ¾ ${fmtM(d.revenue_total)}</div></div>
      <div class="sc r"><div class="sl">Ğ—Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾</div><div class="sv">${d.banned}</div><div class="ss">â€”</div></div>
    </div>
    <div class="cg">
      <div class="cc"><div class="ct">ğŸ’° Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ°, 14 Ğ´Ğ½ĞµĞ¹</div><canvas id="cr" height="130"></canvas></div>
      <div class="cc"><div class="ct">ğŸ‘¤ Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸, 14 Ğ´Ğ½ĞµĞ¹</div><canvas id="crg" height="130"></canvas></div>
    </div>`);
  mkChart('cr',  d.revenue_chart, '#7c6ef5');
  mkChart('crg', d.reg_chart,     '#34d399');
}

function mkChart(id, data, color) {
  if (_charts[id]) _charts[id].destroy();
  _charts[id] = new Chart($(id), {
    type:'line',
    data:{
      labels: data.map(r => String(r.day ?? '').slice(5)),
      datasets:[{data: data.map(r => r.total), borderColor:color,
        backgroundColor:color+'1a', fill:true, tension:.4, pointRadius:3}]
    },
    options:{responsive:true, plugins:{legend:{display:false}},
      scales:{x:{grid:{color:'#252b4222'},ticks:{color:'#64748b',font:{size:10}}},
              y:{grid:{color:'#252b4222'},ticks:{color:'#64748b',font:{size:10}}}}}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const uF = {page:1, search:'', pendingSearch:'',
  sub_status:'', banned:'', reg_from:'', reg_to:'', sub_from:'', sub_to:'',
  showFilters:false};

async function renderUsers() {
  loading();
  const p = new URLSearchParams({
    page:uF.page, per_page:25,
    search:uF.search, sub_status:uF.sub_status, banned:uF.banned,
    reg_from:uF.reg_from, reg_to:uF.reg_to,
    sub_from:uF.sub_from, sub_to:uF.sub_to,
  });
  const d = await api('/users?' + p);
  const tp = Math.ceil(d.total / 25);
  const chips = buildChips();

  setView(`
    <div class="tc">
      <div class="tb">
        <div class="tb-top">
          <h2>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ <span style="color:var(--dim);font-weight:400;font-size:13px">${d.total}</span></h2>
          <div class="tb-row">
            <div class="search-wrap">
              <input class="si" id="usrch" placeholder="ğŸ” Ğ˜Ğ¼Ñ, @username Ğ¸Ğ»Ğ¸ ID"
                value="${esc(uF.pendingSearch)}"
                onkeydown="if(event.key==='Enter'){commitSearch();renderUsers()}">
              <button class="btn btn-acc btn-sm" onclick="commitSearch();renderUsers()">ĞĞ°Ğ¹Ñ‚Ğ¸</button>
            </div>
            <button class="ftgl ${uF.showFilters?'on':''}"
              onclick="uF.showFilters=!uF.showFilters;renderUsers()">
              âš™${countF()?`<span class="f-count">${countF()}</span>`:''}
            </button>
            ${countF()?`<button class="btn btn-d btn-sm" onclick="resetF()">âœ•</button>`:''}
            <button class="btn btn-d btn-icon" onclick="renderUsers()">â†»</button>
          </div>
        </div>

        ${uF.showFilters ? `
        <div class="fp">
          <div class="fg">
            <label>ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°</label>
            <select class="fsel" onchange="uF.sub_status=this.value;uF.page=1;renderUsers()">
              <option value="">Ğ›ÑĞ±Ğ°Ñ</option>
              <option value="active"   ${uF.sub_status==='active'  ?'selected':''}>ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ</option>
              <option value="expiring" ${uF.sub_status==='expiring'?'selected':''}>Ğ˜ÑÑ‚ĞµĞºĞ°ĞµÑ‚ (3 Ğ´Ğ½Ñ)</option>
              <option value="expired"  ${uF.sub_status==='expired' ?'selected':''}>Ğ˜ÑÑ‚ĞµĞºĞ»Ğ°</option>
              <option value="no_sub"   ${uF.sub_status==='no_sub'  ?'selected':''}>ĞĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸</option>
            </select>
          </div>
          <div class="fg">
            <label>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</label>
            <select class="fsel" onchange="uF.banned=this.value;uF.page=1;renderUsers()">
              <option value="">Ğ’ÑĞµ</option>
              <option value="false" ${uF.banned==='false'?'selected':''}>ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ</option>
              <option value="true"  ${uF.banned==='true' ?'selected':''}>Ğ—Ğ°Ğ±Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ğµ</option>
            </select>
          </div>
          <div class="fg">
            <label>Ğ”Ğ°Ñ‚Ğ° Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸</label>
            <div class="date-range">
              <input type="date" class="di" value="${uF.reg_from}" max="${today()}"
                onchange="uF.reg_from=this.value;uF.page=1;renderUsers()">
              <span>â€”</span>
              <input type="date" class="di" value="${uF.reg_to}" max="${today()}"
                onchange="uF.reg_to=this.value;uF.page=1;renderUsers()">
            </div>
          </div>
          <div class="fg">
            <label>Ğ”Ğ°Ñ‚Ğ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸</label>
            <div class="date-range">
              <input type="date" class="di" value="${uF.sub_from}" max="${today()}"
                onchange="uF.sub_from=this.value;uF.page=1;renderUsers()">
              <span>â€”</span>
              <input type="date" class="di" value="${uF.sub_to}" max="${today()}"
                onchange="uF.sub_to=this.value;uF.page=1;renderUsers()">
            </div>
          </div>
          <div class="fg" style="justify-content:flex-end;margin-top:auto">
            <button class="btn btn-d btn-sm"
              onclick="uF.reg_from=today();uF.reg_to=today();uF.page=1;renderUsers()">
              Ğ ĞµĞ³. ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ
            </button>
          </div>
        </div>` : ''}
        ${chips ? `<div class="af-chips">${chips}</div>` : ''}
      </div>

      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</th><th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th><th>ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°</th>
            <th>ĞŸĞ¾Ñ‚Ñ€Ğ°Ñ‡ĞµĞ½Ğ¾</th><th>Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</th><th></th>
          </tr></thead>
          <tbody>${d.users.map(userRow).join('') ||
            '<tr class="empty-row"><td colspan="6">ĞĞµÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹</td></tr>'}</tbody>
        </table>
      </div>
      ${mkPager(uF.page, tp, 'uF.page', 'renderUsers')}
    </div>`);
}

function commitSearch() {
  uF.search = $('usrch')?.value ?? '';
  uF.pendingSearch = uF.search;
  uF.page = 1;
}
function countF() {
  return [uF.search,uF.sub_status,uF.banned,uF.reg_from,uF.reg_to,uF.sub_from,uF.sub_to].filter(Boolean).length;
}
function resetF() {
  Object.assign(uF,{page:1,search:'',pendingSearch:'',sub_status:'',
    banned:'',reg_from:'',reg_to:'',sub_from:'',sub_to:''});
  renderUsers();
}
function buildChips() {
  const c = [];
  const ch = (l,cb) => `<span class="afc">${l}<button onclick="${cb}">Ã—</button></span>`;
  if (uF.search)     c.push(ch(`Â«${esc(uF.search)}Â»`, "uF.search='';uF.pendingSearch='';uF.page=1;renderUsers()"));
  if (uF.sub_status) c.push(ch({active:'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ',expiring:'Ğ˜ÑÑ‚ĞµĞºĞ°ĞµÑ‚',expired:'Ğ˜ÑÑ‚ĞµĞºĞ»Ğ°',no_sub:'ĞĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸'}[uF.sub_status]||uF.sub_status,"uF.sub_status='';uF.page=1;renderUsers()"));
  if (uF.banned)     c.push(ch(uF.banned==='true'?'Ğ—Ğ°Ğ±Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ğµ':'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ',"uF.banned='';uF.page=1;renderUsers()"));
  if (uF.reg_from||uF.reg_to) c.push(ch(`Ğ ĞµĞ³: ${uF.reg_from||'â€¦'}â€“${uF.reg_to||'â€¦'}`,"uF.reg_from='';uF.reg_to='';uF.page=1;renderUsers()"));
  if (uF.sub_from||uF.sub_to) c.push(ch(`ĞŸĞ¾ĞºÑƒĞ¿ĞºĞ°: ${uF.sub_from||'â€¦'}â€“${uF.sub_to||'â€¦'}`,"uF.sub_from='';uF.sub_to='';uF.page=1;renderUsers()"));
  return c.join('');
}

function userRow(u) {
  const hasActive = u.sub_id && u.sub_active && new Date(u.expires_at) > new Date();
  const hasAny    = !!u.sub_id;
  let actions = '';
  if (!hasAny || !u.sub_active || new Date(u.expires_at) <= new Date())
    actions = `<button class="btn btn-grn btn-sm" onclick="confirmGrant(${u.user_id},'${esc(u.first_name)}')">ğŸ Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ</button>`;
  else
    actions = `<button class="btn btn-acc btn-sm" onclick="confirmExtend(${u.user_id},'${esc(u.first_name)}')">â•</button>
               <button class="btn btn-red btn-sm" onclick="confirmDisable(${u.user_id},'${esc(u.first_name)}')">â¹</button>`;

  return `<tr>
    <td>
      <div style="font-weight:600;font-size:13px">${esc(u.first_name||'â€”')}</div>
      <div style="color:var(--dim);font-size:11px">${u.username?'@'+esc(u.username)+' ':''}<code>${u.user_id}</code></div>
    </td>
    <td><span class="bd ${u.is_banned?'r':'g'}">${u.is_banned?'ğŸš« Ğ‘Ğ°Ğ½':'âœ“ OK'}</span></td>
    <td>${subBadge(u)}</td>
    <td style="white-space:nowrap">${fmtM(u.total_spent)}</td>
    <td style="white-space:nowrap;font-size:11px">${fmtDate(u.registered_at)}</td>
    <td><div class="acts">${actions}<button class="btn btn-d btn-icon btn-sm" onclick="showUser(${u.user_id})" title="ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ĞµĞµ">â€¦</button></div></td>
  </tr>`;
}

function subBadge(u) {
  if (!u.sub_id) return '<span class="bd d">ĞĞµÑ‚</span>';
  const exp = new Date(u.expires_at), now = new Date();
  if (!u.sub_active || exp <= now) return '<span class="bd r">Ğ˜ÑÑ‚ĞµĞºĞ»Ğ°</span>';
  const days = Math.ceil((exp - now) / 86400000);
  return `<div class="sub-col"><span class="bd ${days<=3?'y':'g'}">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°</span><span class="sub-days">${days}Ğ´.</span></div>`;
}

// â”€â”€ User detail modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showUser(uid) {
  openMo('<div class="ld"><div class="sp"></div></div>');
  const d = await api('/users/' + uid);
  if (d.error) { closeMo(); toast(d.error, 'err'); return; }
  const u = d.user;
  const hasActive = u.sub_id && u.sub_active && new Date(u.expires_at) > new Date();

  const subRows = d.subscriptions.slice(0,5).map(s => {
    const ok = s.is_active && new Date(s.expires_at) > new Date();
    return `<tr><td>#${s.id}</td>
      <td style="word-break:break-all"><code style="font-size:10px">${esc(s.marzban_username)}</code></td>
      <td><span class="bd ${ok?'g':'r'}">${ok?'ĞĞºÑ‚Ğ¸Ğ².':'Ğ˜ÑÑ‚ĞµĞºĞ»Ğ°'}</span></td>
      <td>${fmtD(s.expires_at)}</td></tr>`;
  }).join('') || '<tr><td colspan="4" style="text-align:center;color:var(--dim);padding:10px">â€”</td></tr>';

  const payRows = d.payments.slice(0,5).map(p =>
    `<tr><td><span class="bd ${p.status==='succeeded'?'g':p.status==='pending'?'y':'r'}">${p.status}</span></td>
    <td>${fmtM(p.amount)}</td><td>${fmtD(p.created_at)}</td></tr>`
  ).join('') || '<tr><td colspan="3" style="text-align:center;color:var(--dim);padding:10px">â€”</td></tr>';

  openMo(`
    <div class="mo-handle"></div>
    <div class="mo-head">
      <div>
        <div class="mo-title">${esc(u.first_name)}${u.username?' (@'+esc(u.username)+')':''}</div>
        <div class="mo-sub">ID: ${u.user_id}</div>
      </div>
      <button class="mo-x" onclick="closeMo()">âœ•</button>
    </div>
    <div class="ir"><span class="il">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</span><span class="iv"><span class="bd ${u.is_banned?'r':'g'}">${u.is_banned?'Ğ—Ğ°Ğ±Ğ°Ğ½ĞµĞ½':'ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½'}</span></span></div>
    <div class="ir"><span class="il">ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°</span><span class="iv">${subBadge(u)}</span></div>
    <div class="ir"><span class="il">Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</span><span class="iv">${fmtD(u.registered_at)}</span></div>
    <div class="ir"><span class="il">ĞŸĞ¾Ñ‚Ñ€Ğ°Ñ‡ĞµĞ½Ğ¾</span><span class="iv">${fmtM(u.total_spent)}</span></div>
    <div class="mo-sect">ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸</div>
    <table class="mini-t"><thead><tr><th>ID</th><th>Marzban</th><th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th><th>Ğ˜ÑÑ‚ĞµĞºĞ°ĞµÑ‚</th></tr></thead>
    <tbody>${subRows}</tbody></table>
    <div class="mo-sect">ĞŸĞ»Ğ°Ñ‚ĞµĞ¶Ğ¸</div>
    <table class="mini-t"><thead><tr><th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th><th>Ğ¡ÑƒĞ¼Ğ¼Ğ°</th><th>Ğ”Ğ°Ñ‚Ğ°</th></tr></thead>
    <tbody>${payRows}</tbody></table>
    <div class="mo-act">
      ${!hasActive?`<button class="btn btn-grn" onclick="closeMo();confirmGrant(${u.user_id},'${esc(u.first_name)}')">ğŸ Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ</button>`:''}
      ${hasActive?`<button class="btn btn-acc" onclick="closeMo();confirmExtend(${u.user_id},'${esc(u.first_name)}')">â• ĞŸÑ€Ğ¾Ğ´Ğ»Ğ¸Ñ‚ÑŒ</button>`:''}
      ${hasActive?`<button class="btn btn-red" onclick="closeMo();confirmDisable(${u.user_id},'${esc(u.first_name)}')">â¹ ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ</button>`:''}
      ${u.is_banned
        ?`<button class="btn btn-grn" onclick="doBan(${u.user_id},false)">âœ“ Ğ Ğ°Ğ·Ğ±Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>`
        :`<button class="btn btn-red" onclick="doBan(${u.user_id},true)">ğŸš« Ğ—Ğ°Ğ±Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>`}
    </div>`);
}

// â”€â”€ Sub actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function confirmGrant(uid, name) {
  openMo(`<div class="mo-handle"></div>
    <div class="confirm-icon">ğŸ</div>
    <div class="mo-title" style="text-align:center;margin-bottom:8px">Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ</div>
    <div class="confirm-msg">Ğ‘ÑƒĞ´ĞµÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ² Marzban<br>Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ´Ğ»Ñ <b>${esc(name)}</b></div>
    <div class="mo-btns">
      <button class="btn btn-d btn-lg" onclick="closeMo()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn btn-grn btn-lg" id="cb" onclick="doGrant(${uid})">âœ“ Ğ’Ñ‹Ğ´Ğ°Ñ‚ÑŒ</button>
    </div>`);
}
function confirmExtend(uid, name) {
  openMo(`<div class="mo-handle"></div>
    <div class="confirm-icon">â•</div>
    <div class="mo-title" style="text-align:center;margin-bottom:8px">ĞŸÑ€Ğ¾Ğ´Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ</div>
    <div class="confirm-msg">ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ° Ğ² Marzban Ğ¸ Ğ‘Ğ”<br>Ğ´Ğ»Ñ <b>${esc(name)}</b></div>
    <div class="mo-btns">
      <button class="btn btn-d btn-lg" onclick="closeMo()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn btn-acc btn-lg" id="cb" onclick="doExtend(${uid})">âœ“ ĞŸÑ€Ğ¾Ğ´Ğ»Ğ¸Ñ‚ÑŒ</button>
    </div>`);
}
function confirmDisable(uid, name) {
  openMo(`<div class="mo-handle"></div>
    <div class="confirm-icon">â¹</div>
    <div class="mo-title" style="text-align:center;margin-bottom:8px">ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºÑƒ</div>
    <div class="confirm-msg">ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° <b>${esc(name)}</b> Ğ±ÑƒĞ´ĞµÑ‚ Ğ´ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°</div>
    <label style="display:flex;align-items:center;gap:8px;justify-content:center;font-size:13px;
      color:var(--dim);margin-bottom:18px;cursor:pointer">
      <input type="checkbox" id="del-mz" style="accent-color:var(--acc);width:15px;height:15px">
      Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ· Marzban
    </label>
    <div class="mo-btns">
      <button class="btn btn-d btn-lg" onclick="closeMo()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn btn-red btn-lg" id="cb" onclick="doDisable(${uid})">âœ“ ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ</button>
    </div>`);
}

async function doGrant(uid)   { btnLoad('cb'); const d = await api('/users/'+uid+'/sub/grant',  {method:'POST',body:{}}); closeMo(); d.error?toast(d.error,'err'):(toast('âœ… ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ²Ñ‹Ğ´Ğ°Ğ½Ğ°!'),renderUsers()); }
async function doExtend(uid)  { btnLoad('cb'); const d = await api('/users/'+uid+'/sub/extend', {method:'POST',body:{}}); closeMo(); d.error?toast(d.error,'err'):(toast('âœ… ĞŸÑ€Ğ¾Ğ´Ğ»ĞµĞ½Ğ°!'),renderUsers()); }
async function doDisable(uid) {
  const del = $('del-mz')?.checked||false;
  btnLoad('cb');
  const d = await api('/users/'+uid+'/sub/disable', {method:'POST',body:{delete_marzban:del}});
  closeMo(); d.error?toast(d.error,'err'):(toast('ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ°'),renderUsers());
}
async function doBan(uid, banned) {
  const d = await api('/users/'+uid+'/ban', {method:'POST',body:{banned}});
  if (d.ok) { toast(banned?'ğŸš« Ğ—Ğ°Ğ±Ğ°Ğ½ĞµĞ½':'âœ“ Ğ Ğ°Ğ·Ğ±Ğ°Ğ½ĞµĞ½', banned?'err':'ok'); closeMo(); renderUsers(); }
}
function btnLoad(id) { const el=$(id); if(el){el.textContent='â³';el.disabled=true;} }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAYMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const pF = {page:1, status:''};

async function renderPayments() {
  loading();
  const d = await api('/payments?' + new URLSearchParams({page:pF.page, per_page:25, status:pF.status}));
  const tp = Math.ceil(d.total / 25);

  const rows = d.payments.map(p => `<tr>
    <td>
      <div style="font-weight:500">${esc(p.first_name||'â€”')}</div>
      <div style="color:var(--dim);font-size:11px">${p.username?'@'+esc(p.username)+' ':''}<code>${p.user_id}</code></div>
    </td>
    <td><span class="bd ${p.status==='succeeded'?'g':p.status==='pending'?'y':'r'}">${p.status}</span></td>
    <td style="font-weight:600;white-space:nowrap">${fmtM(p.amount)}</td>
    <td style="font-size:10px;color:var(--dim);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(p.yukassa_payment_id||'â€”')}</td>
    <td style="font-size:11px;white-space:nowrap">${fmtD(p.created_at)}</td>
  </tr>`).join('');

  setView(`
    <div class="tc">
      <div class="tb">
        <div class="tb-top">
          <h2>ĞŸĞ»Ğ°Ñ‚ĞµĞ¶Ğ¸ <span style="color:var(--dim);font-weight:400;font-size:13px">${d.total}</span></h2>
          <div class="tb-row">
            <select class="fsel" onchange="pF.status=this.value;pF.page=1;renderPayments()">
              <option value="">Ğ’ÑĞµ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹</option>
              <option value="succeeded" ${pF.status==='succeeded'?'selected':''}>Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ</option>
              <option value="pending"   ${pF.status==='pending'  ?'selected':''}>ĞĞ¶Ğ¸Ğ´Ğ°ÑÑ‰Ğ¸Ğµ</option>
              <option value="canceled"  ${pF.status==='canceled' ?'selected':''}>ĞÑ‚Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ñ‹Ğµ</option>
            </select>
            <button class="btn btn-d btn-icon" onclick="renderPayments()">â†»</button>
          </div>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</th><th>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th><th>Ğ¡ÑƒĞ¼Ğ¼Ğ°</th><th>Ğ®Kassa ID</th><th>Ğ”Ğ°Ñ‚Ğ°</th></tr></thead>
          <tbody>${rows||'<tr class="empty-row"><td colspan="5">ĞĞµÑ‚ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹</td></tr>'}</tbody>
        </table>
      </div>
      ${mkPager(pF.page, tp, 'pF.page', 'renderPayments')}
    </div>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BROADCAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const AUDIENCES = [
  {key:'all',       name:'Ğ’ÑĞµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸',   desc:'Ğ’ÑĞµ Ğ½ĞµĞ·Ğ°Ğ±Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ğµ'},
  {key:'active',    name:'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°',  desc:'ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ° Ğ¿Ñ€ÑĞ¼Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ'},
  {key:'expiring',  name:'Ğ˜ÑÑ‚ĞµĞºĞ°ĞµÑ‚ ÑĞºĞ¾Ñ€Ğ¾',     desc:'ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ¸ÑÑ‚ĞµĞºĞ°ĞµÑ‚ Ğ² Ğ±Ğ»Ğ¸Ğ¶. 3 Ğ´Ğ½Ñ'},
  {key:'expired',   name:'ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° Ğ¸ÑÑ‚ĞµĞºĞ»Ğ°',   desc:'Ğ‘Ñ‹Ğ»Ğ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°, ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°'},
  {key:'no_sub',    name:'Ğ‘ĞµĞ· Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸',       desc:'ĞĞ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°Ğ»Ğ¸'},
  {key:'no_payment',name:'Ğ‘ĞµĞ· Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹',       desc:'Ğ—Ğ°Ñ€ĞµĞ³., Ğ½Ğ¾ Ğ½Ğ¸ Ñ€Ğ°Ğ·Ñƒ Ğ½Ğµ Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ğ»Ğ¸'},
  {key:'paid_once', name:'Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ 1 Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶',    desc:'ĞšÑƒĞ¿Ğ¸Ğ»Ğ¸ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· â€” Ğ½Ğµ Ğ²ĞµÑ€Ğ½ÑƒĞ»Ğ¸ÑÑŒ'},
];

let bAud = 'all';
let bCounts = {};

async function renderBroadcast() {
  // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ¸ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾
  const counts = await Promise.all(
    AUDIENCES.map(a => api('/broadcast/count?audience=' + a.key))
  );
  AUDIENCES.forEach((a, i) => { bCounts[a.key] = counts[i]?.count ?? '?'; });
  _renderBroadcastUI();
}

function _renderBroadcastUI() {
  const cards = AUDIENCES.map(a => `
    <div class="aud-card ${bAud===a.key?'sel':''}" onclick="bAud='${a.key}';_renderBroadcastUI()">
      <div class="aud-name">${a.name}</div>
      <div class="aud-desc">${a.desc}</div>
      <div class="aud-count">${bCounts[a.key] ?? 'â€¦'} Ñ‡ĞµĞ».</div>
    </div>`).join('');

  setView(`
    <div class="tc bpage" style="padding:20px">
      <h2>ğŸ“¢ Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ°</h2>
      <p class="hint" style="margin-top:4px">HTML Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ: &lt;b&gt;, &lt;i&gt;, &lt;code&gt;, &lt;a href&gt;</p>
      <textarea class="bcast-ta" id="bt" placeholder="Ğ¢ĞµĞºÑÑ‚ Ñ€Ğ°ÑÑÑ‹Ğ»ĞºĞ¸..."></textarea>
      <div class="aud-label">ĞÑƒĞ´Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ</div>
      <div class="aud-grid">${cards}</div>
      <div class="bcast-footer">
        <button class="btn btn-acc btn-lg" id="sbtn" onclick="sendBroadcast()">
          ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ
        </button>
        <span class="bcast-total">ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ĞµĞ»ĞµĞ¹: <b>${bCounts[bAud] ?? 'â€¦'}</b></span>
      </div>
      <div id="bres" style="display:none"></div>
    </div>`);
}

async function sendBroadcast() {
  const text = $('bt')?.value?.trim();
  if (!text) { toast('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‚ĞµĞºÑÑ‚', 'err'); return; }
  const btn = $('sbtn');
  btn.textContent = 'â³ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ°...'; btn.disabled = true;
  const d = await api('/broadcast', {method:'POST', body:{text, audience:bAud}});
  btn.textContent = 'ğŸ“¤ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ'; btn.disabled = false;
  if (d.error) { toast(d.error, 'err'); return; }
  const el = $('bres');
  el.style.display = 'block';
  el.className = 'bcast-ok';
  el.innerHTML = `âœ… ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾: <b>${d.sent}</b>, Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº: <b>${d.failed}</b>`;
  // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ°ÑƒĞ´Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¸
  bCounts[bAud] = d.total;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGINATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function mkPager(page, total, varName, fn) {
  if (total <= 1) return '';
  const btns = [];
  const s = Math.max(1, page-2), e = Math.min(total, page+2);
  if (s > 1) btns.push(`<button class="pb" onclick="${varName}=1;${fn}()">1</button>${s>2?'<span class="ptxt">â€¦</span>':''}`);
  for (let i=s;i<=e;i++) btns.push(`<button class="pb ${i===page?'on':''}" onclick="${varName}=${i};${fn}()">${i}</button>`);
  if (e < total) btns.push(`${e<total-1?'<span class="ptxt">â€¦</span>':''}<button class="pb" onclick="${varName}=${total};${fn}()">${total}</button>`);
  return `<div class="pg">
    <button class="pb" onclick="${varName}=Math.max(1,${page}-1);${fn}()" ${page<=1?'disabled':''}>â†</button>
    ${btns.join('')}
    <button class="pb" onclick="${varName}=Math.min(${total},${page}+1);${fn}()" ${page>=total?'disabled':''}>â†’</button>
  </div>`;
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkAuth();
</script>
</body>
</html>
